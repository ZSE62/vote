<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Radnego @mperek</title>
    <style>
        :root { --p: #2980b9; --s: #27ae60; --d: #e74c3c; --purple: #9b59b6; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 400px; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 15px; }

        .id-card { background: linear-gradient(135deg, #1e3799, #0984e3); color: white; padding: 25px; border-radius: 15px; position: relative; cursor: pointer; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .stat-item { background: white; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .stat-val { display: block; font-size: 20px; font-weight: bold; color: var(--p); }

        .history-list { font-size: 11px; max-height: 120px; overflow-y: auto; background: #fafafa; padding: 10px; border-radius: 10px; border: 1px solid #eee; }
        .history-item { border-bottom: 1px solid #eee; padding: 8px 0; color: #444; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-enter { background: var(--s); color: white; font-size: 16px; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3); }
        .btn-za { background: var(--s); color: white; }
        .btn-przeciw { background: var(--d); color: white; }
        .btn-wstrzymuje { background: #f1c40f; color: black; }

        #legitymacjaModal, #wniosekModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 100%; max-width: 320px; border-radius: 20px; padding: 30px; text-align: center; position: relative; }
        textarea { width: 100%; height: 100px; border: 1px solid #ddd; border-radius: 10px; padding: 10px; margin: 10px 0; resize: none; box-sizing: border-box; font-family: inherit; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginArea" class="card" style="text-align: center;">
            <h1 style="margin-bottom:5px;">@mperek.</h1>
            <p style="font-size: 12px; color: #777; margin-bottom: 20px;">PORTAL RADNEGO ZSE</p>
            <input type="text" id="accessCode" placeholder="KOD DOSTƒòPU" style="width:100%; padding:15px; font-size:18px; text-align:center; border-radius:10px; border: 1px solid #ddd; outline: none;">
            <button class="btn" style="background:var(--p); color:white" onclick="zalogujDoProfilu()">ZALOGUJ SIƒò</button>
        </div>

        <div id="profileArea" style="display:none;">
            <div class="id-card" onclick="document.getElementById('legitymacjaModal').style.display='flex'">
                <small style="opacity: 0.7;">LEGITYMACJA RADNEGO (Kliknij)</small>
                <h2 id="idName" style="margin:5px 0;">-</h2>
                <p id="idPos" style="font-size:12px; opacity:0.9; margin:0;"></p>
                <div style="position:absolute; right:15px; bottom:15px; font-size:40px; opacity:0.1;">üèõ</div>
            </div>
            <div class="stat-grid">
                <div class="stat-item"><span class="stat-val" id="statFrekwencja">0%</span><small>FREKWENCJA</small></div>
                <div class="stat-item"><span class="stat-val" id="statSesje">0</span><small>OBECNO≈öCI</small></div>
            </div>
            <div class="card">
                <h4 style="margin: 0 0 10px 0; font-size: 11px; color: #555;">TWOJE WNIOSKI (SESJA)</h4>
                <div id="mojeWnioski" class="history-list">Do≈ÇƒÖcz do sesji, aby wys≈Çaƒá wnioski.</div>
            </div>
            <button class="btn btn-enter" onclick="wejdzNaSesje()">DO≈ÅƒÑCZ DO SESJI ‚ñ∂</button>
            <button class="btn" style="background:none; color:#999; font-size:11px;" onclick="localStorage.clear(); location.reload();">Wyloguj z urzƒÖdzenia</button>
        </div>

        <div id="voteArea" class="card" style="display:none;">
            <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <span id="activeName" style="font-weight:bold;"></span>
                <span style="color:var(--s); font-weight: bold;">‚óè NA SALI OBRAD</span>
            </div>
            <h2 id="vTitle" style="text-align:center; font-size: 18px; min-height: 50px; display: flex; align-items: center; justify-content: center;">Czekanie na temat...</h2>
            <div id="btns"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 25px; border-top: 1px solid #eee; padding-top: 20px;">
                <button class="btn" style="background:#3498db; color:white" onclick="toggleHand()">G≈ÅOS üñê</button>
                <button class="btn" style="background:var(--purple); color:white" onclick="document.getElementById('wniosekModal').style.display='flex'">WNIOSEK üìù</button>
            </div>
        </div>
    </div>

    <div id="legitymacjaModal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="font-size:50px; margin-bottom: 15px;">üë§</div>
            <h2 id="legName" style="margin:0;"></h2>
            <p id="legPosM" style="color: var(--p); font-weight: bold; margin: 5px 0 20px 0;"></p>
            <div style="text-align: left; background: #f9f9f9; padding: 15px; border-radius: 10px; font-size: 14px; line-height: 1.6;">
                Klasa: <b id="legClass"></b><br>Komisja: <b id="legComm"></b>
            </div>
            <button class="btn" style="background:#eee; margin-top: 20px;" onclick="document.getElementById('legitymacjaModal').style.display='none'">ZAMKNIJ</button>
        </div>
    </div>

    <div id="wniosekModal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin:0">Nowy wniosek</h3>
            <textarea id="trescWniosku" placeholder="Wpisz tre≈õƒá wniosku..."></textarea>
            <button class="btn" style="background:var(--purple); color:white" onclick="wyslijWniosek()">WY≈öLIJ WNIOSEK</button>
            <button class="btn" style="background:#eee;" onclick="document.getElementById('wniosekModal').style.display='none'">Anuluj</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM", authDomain: "votelive-f469d.firebaseapp.com", projectId: "votelive-f469d", appId: "1:959356764271:web:76f0284a0a1ce6e9874d9a" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "ankiet", "vote");

        let myCode = localStorage.getItem("rCode");
        let myData = null;

        if(myCode) zaladujProfil();

        async function zaladujProfil() {
            const snap = await getDoc(doc(db, "kody_dostepu", myCode));
            if(!snap.exists()) return;
            myData = snap.data();
            document.getElementById('loginArea').style.display = "none";
            document.getElementById('profileArea').style.display = "block";
            
            document.getElementById('idName').innerText = myData.nazwisko;
            document.getElementById('legName').innerText = myData.nazwisko;
            document.getElementById('idPos').innerText = myData.stanowisko;
            document.getElementById('legPosM').innerText = myData.stanowisko;
            document.getElementById('legClass').innerText = myData.klasa || "-";
            document.getElementById('legComm').innerText = myData.komisja || "-";

            const ob = myData.sesjeObecne || 0;
            const wsz = myData.sesjeWszystkie || 0;
            document.getElementById('statFrekwencja').innerText = wsz > 0 ? Math.round((ob/wsz)*100) + "%" : "100%";
            document.getElementById('statSesje').innerText = ob;
        }

        window.zalogujDoProfilu = async () => {
            const c = document.getElementById('accessCode').value.trim();
            const snap = await getDoc(doc(db, "kody_dostepu", c));
            if(snap.exists()) { localStorage.setItem("rCode", c); location.reload(); }
            else alert("B≈Çƒôdny kod!");
        };

        window.wejdzNaSesje = async () => {
            const snapS = await getDoc(docRef);
            const d = snapS.data();
            if(d.status === "reset_wszystkich" || d.status === "zamkniete") return alert("Sesja nie jest aktywna.");

            const weryf = prompt("Podaj kod ponownie, aby wej≈õƒá na salƒô:");
            if(weryf !== myCode) return alert("B≈Çƒôdny kod!");

            const rRef = doc(db, "kody_dostepu", myCode);
            const rSnap = await getDoc(rRef);
            if(rSnap.data().zalogowany) return alert("Ten radny jest ju≈º zalogowany!");

            // Logika frekwencji oparta o sessionID
            if(rSnap.data().lastSessionID !== d.sessionID) {
                await updateDoc(rRef, { sesjeObecne: increment(1), lastSessionID: d.sessionID });
            }

            await updateDoc(rRef, { zalogowany: true });
            await updateDoc(docRef, { obecni: arrayUnion(myData.nazwisko) });
            
            document.getElementById('profileArea').style.display = "none";
            document.getElementById('voteArea').style.display = "block";
            document.getElementById('activeName').innerText = myData.nazwisko;
            startSyncSesja();
        };

        function startSyncSesja() {
            onSnapshot(docRef, snap => {
                const d = snap.data();
                if(d.status === "reset_wszystkich") {
                    updateDoc(doc(db, "kody_dostepu", myCode), { zalogowany: false });
                    location.reload();
                }

                document.getElementById('vTitle').innerText = d.status === "otwarte" ? d.tytul : "Oczekiwanie na g≈Çosowanie...";
                
                const div = document.getElementById('btns');
                if(d.status !== "otwarte") div.innerHTML = "";
                else {
                    const safe = myData.nazwisko.replace(/[.#$/[\]]/g, "");
                    const juz = d.lista_glosow && d.lista_glosow[safe];
                    div.innerHTML = "";
                    ["ZA", "PRZECIW", "WSTRZYMA≈ÅO SIƒò"].forEach(k => {
                        const b = document.createElement('button');
                        b.innerText = k; b.className = "btn " + (k==="ZA"?"btn-za":k==="PRZECIW"?"btn-przeciw":"btn-wstrzymuje");
                        if(juz) b.disabled = true;
                        b.onclick = async () => { if(confirm("G≈Çosujesz: "+k+"?")) await updateDoc(docRef, { [`wyniki.${k}`]: increment(1), [`lista_glosow.${safe}`]: k }); };
                        div.appendChild(b);
                    });
                }

                const moje = (d.wnioski || []).filter(w => w.radny === myData.nazwisko);
                document.getElementById('mojeWnioski').innerHTML = moje.length > 0 ? 
                    moje.map(w => `<div class="history-item"><b>${w.czas}</b>: ${w.tresc}</div>`).join('') : "Brak wniosk√≥w.";
            });
        }

        window.toggleHand = async () => {
            const s = await getDoc(docRef);
            if((s.data().rece || []).includes(myData.nazwisko)) await updateDoc(docRef, { rece: arrayRemove(myData.nazwisko) });
            else await updateDoc(docRef, { rece: arrayUnion(myData.nazwisko) });
        };

        window.wyslijWniosek = async () => {
            const t = document.getElementById('trescWniosku').value;
            if(!t) return;
            await updateDoc(docRef, { wnioski: arrayUnion({ radny: myData.nazwisko, tresc: t, czas: new Date().toLocaleTimeString() }) });
            document.getElementById('wniosekModal').style.display = 'none';
            document.getElementById('trescWniosku').value = "";
        };
    </script>
</body>
</html>
