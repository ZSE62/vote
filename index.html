<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strefa Radnego @mperek</title>
    <style>
        :root { --primary: #2980b9; --success: #27ae60; --purple: #9b59b6; --dark: #2c3e50; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 400px; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: left; }
        
        /* Legitymacja */
        .id-card { background: linear-gradient(135deg, var(--dark), #34495e); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; position: relative; overflow: hidden; }
        .id-card h2 { margin: 5px 0; font-size: 22px; }
        .id-card small { opacity: 0.7; text-transform: uppercase; font-size: 10px; letter-spacing: 1px; }
        .id-card .icon { position: absolute; right: -10px; bottom: -10px; font-size: 80px; opacity: 0.1; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #fff; padding: 15px; border-radius: 15px; border: 1px solid #eee; text-align: center; }
        .stat-val { display: block; font-size: 20px; font-weight: bold; }

        /* Paski i Statusy */
        .progress-bg { background: #eee; height: 8px; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; width: 0%; transition: 0.5s; background: var(--primary); }
        .queue-box { background: #ebf5fb; padding: 12px; border-radius: 10px; margin-bottom: 15px; display: none; font-size: 13px; }

        /* Przyciski */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; margin: 5px 0; }
        .btn-main { background: var(--primary); color: white; }
        .btn-enter { background: var(--success); color: white; padding: 20px; font-size: 16px; }
        .btn-za { background: var(--success); color: white; font-size: 18px; }
        .btn-przeciw { background: #e74c3c; color: white; font-size: 18px; }
        .btn-wstrzymuje { background: #f1c40f; color: black; font-size: 18px; }

        /* Modal */
        #modalWniosek { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 350px; border-top: 6px solid var(--purple); }
        textarea { width: 100%; height: 100px; border: 1px solid #ddd; border-radius: 10px; padding: 10px; margin: 10px 0; resize: none; font-family: inherit; box-sizing: border-box; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginArea" class="card" style="text-align: center; margin-top: 50px;">
            <h1>@mperek.</h1>
            <p>Wprowad≈∫ kod dostƒôpu do strefy radnego</p>
            <input type="text" id="accessCode" placeholder="KOD" style="width: 100%; padding: 15px; text-align: center; font-size: 20px; border-radius: 10px; border: 1px solid #ccc; box-sizing: border-box;">
            <button class="btn btn-main" onclick="zaloguj()" style="margin-top: 15px;">ZALOGUJ SIƒò</button>
        </div>

        <div id="profileArea" style="display:none;">
            <div class="id-card">
                <small>Legitymacja Radnego RSU</small>
                <h2 id="profileName">-</h2>
                <div class="icon">üèõ</div>
            </div>
            <div class="stats-grid">
                <div class="stat-box"><span class="stat-val" style="color:var(--success)">100%</span><small>OBECNO≈öƒÜ</small></div>
                <div class="stat-box"><span class="stat-val" style="color:var(--purple)" id="statWnioski">0</span><small>WNIOSKI</small></div>
            </div>
            <button class="btn btn-enter" onclick="checkSession()">WEJD≈π NA SESJƒò ‚ñ∂</button>
            <button class="btn" style="background: none; color: #7f8c8d; font-size: 12px;" onclick="wyloguj()">Wyloguj z urzƒÖdzenia</button>
        </div>

        <div id="voteArea" class="card" style="display:none;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #777; margin-bottom: 10px;">
                <span id="sessionUser"></span>
                <span id="kworumStatus"></span>
            </div>
            <div class="progress-bg"><div id="kworumBar" class="progress-bar"></div></div>
            <div id="queueStatus" class="queue-box"></div>
            <h2 id="title" style="text-align: center; font-size: 18px; margin: 20px 0;">Oczekiwanie...</h2>
            <div id="btns"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <button id="handBtn" class="btn" style="background:#3498db; color:white;" onclick="toggleHand()">PODNIE≈ö RƒòKƒò</button>
                <button class="btn" style="background:var(--purple); color:white;" onclick="openModal()">WNIOSKI</button>
            </div>
        </div>
    </div>

    <div id="modalWniosek"><div class="modal-content">
        <h3 style="margin:0">Nowy wniosek</h3>
        <textarea id="trescWniosku" placeholder="Wpisz tre≈õƒá..."></textarea>
        <button class="btn" style="background:var(--purple); color:white;" onclick="wyslijWniosek()">ZATWIERD≈π I WY≈öLIJ üì©</button>
        <button class="btn" style="background:#eee;" onclick="closeModal()">Anuluj</button>
    </div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, getDoc, arrayUnion, arrayRemove, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM", authDomain: "votelive-f469d.firebaseapp.com", projectId: "votelive-f469d", appId: "1:959356764271:web:76f0284a0a1ce6e9874d9a" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "ankiet", "vote");

        let currentName = localStorage.getItem("radnyName");
        let currentCode = localStorage.getItem("radnyCode");

        if(currentName) { showArea('profileArea'); document.getElementById('profileName').innerText = currentName; }

        window.zaloguj = async () => {
            const code = document.getElementById('accessCode').value.trim();
            const snap = await getDoc(doc(db, "kody_dostepu", code));
            if(!snap.exists()) return alert("B≈Çƒôdny kod!");
            localStorage.setItem("radnyName", snap.data().nazwisko);
            localStorage.setItem("radnyCode", code);
            location.reload();
        };

        window.wyloguj = () => { localStorage.clear(); location.reload(); };

        window.checkSession = async () => {
            const snap = await getDoc(docRef);
            const status = snap.data().status;
            if(status === "reset_wszystkich" || status === "zamkniete") return alert("Sesja nie jest aktywna.");
            
            const v = prompt("Wpisz kod ponownie dla weryfikacji:");
            if(v !== currentCode) return alert("B≈Çƒôdny kod!");
            
            await updateDoc(docRef, { obecni: arrayUnion(currentName) });
            showArea('voteArea');
            startSessionSync();
        };

        function showArea(id) {
            ['loginArea', 'profileArea', 'voteArea'].forEach(a => document.getElementById(a).style.display = a === id ? 'block' : 'none');
        }

        function startSessionSync() {
            onSnapshot(docRef, async (snap) => {
                const data = snap.data();
                if(data.status === "reset_wszystkich" || data.status === "zamkniete") {
                    alert("Sesja zako≈Ñczona.");
                    location.reload(); 
                    return;
                }

                // Kworum
                const kodySnap = await getDocs(collection(db, "kody_dostepu"));
                const l_max = kodySnap.size;
                const l_ob = data.obecni?.length || 0;
                document.getElementById('kworumBar').style.width = (l_ob/l_max*100) + "%";
                document.getElementById('kworumStatus').innerText = `Obecno≈õƒá: ${l_ob}/${l_max}`;
                document.getElementById('kworumBar').style.background = l_ob >= Math.floor(l_max/2)+1 ? "#27ae60" : "#e67e22";

                // Kolejka
                const rece = data.rece || [];
                const mojaPoz = rece.indexOf(currentName);
                const qBox = document.getElementById('queueStatus');
                const hBtn = document.getElementById('handBtn');
                
                if(mojaPoz !== -1) {
                    qBox.style.display = 'block';
                    hBtn.innerText = "OPU≈öƒÜ RƒòKƒò";
                    if(mojaPoz === 0) { qBox.innerHTML = "<b>‚≠ê TWOJA KOLEJ!</b>"; qBox.style.background = "#d4efdf"; }
                    else { qBox.innerHTML = `Pozycja w kolejce: <b>${mojaPoz + 1}</b>`; qBox.style.background = "#ebf5fb"; }
                } else { qBox.style.display = 'none'; hBtn.innerText = "PODNIE≈ö RƒòKƒò"; }

                // G≈Çosowanie
                const div = document.getElementById('btns');
                const title = document.getElementById('title');
                if(data.status !== "otwarte") { title.innerText = "SESJA RADY"; div.innerHTML = ""; return; }
                
                title.innerText = data.tytul;
                const safe = currentName.replace(/[.#$/[\]]/g, "");
                const juz = data.lista_glosow && data.lista_glosow[safe];
                div.innerHTML = "";
                ["ZA", "PRZECIW", "WSTRZYMA≈ÅO SIƒò"].forEach(k => {
                    const b = document.createElement('button');
                    b.innerText = k; b.className = "btn " + (k==="ZA"?"btn-za":k==="PRZECIW"?"btn-przeciw":"btn-wstrzymuje");
                    if(juz) b.disabled = true;
                    b.onclick = async () => { if(confirm("Na pewno?")) await updateDoc(docRef, { [`wyniki.${k}`]: increment(1), [`lista_glosow.${safe}`]: k }); };
                    div.appendChild(b);
                });
            });
        }

        window.toggleHand = async () => {
            const s = await getDoc(docRef);
            if((s.data().rece || []).includes(currentName)) await updateDoc(docRef, { rece: arrayRemove(currentName) });
            else await updateDoc(docRef, { rece: arrayUnion(currentName) });
        };

        window.openModal = () => document.getElementById('modalWniosek').style.display = 'flex';
        window.closeModal = () => document.getElementById('modalWniosek').style.display = 'none';
        window.wyslijWniosek = async () => {
            const t = document.getElementById('trescWniosku').value;
            if(!t) return;
            await updateDoc(docRef, { wnioski: arrayUnion({ radny: currentName, tresc: t, czas: new Date().toLocaleTimeString() }) });
            closeModal(); document.getElementById('trescWniosku').value = ""; alert("Wys≈Çano.");
        };
    </script>
</body>
</html>
