<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@mperek. | Portal Radnego</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --p: #4f46e5; --s: #10b981; --d: #ef4444; --bg: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 420px; }
        .card { background: white; padding: 25px; border-radius: 28px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .id-card { background: linear-gradient(135deg, #4f46e5, #818cf8); color: white; padding: 25px; border-radius: 24px; margin-bottom: 20px; }
        .btn { width: 100%; padding: 18px; border: none; border-radius: 18px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 15px; margin-bottom: 10px; font-family: inherit; }
        .btn-main { background: var(--p); color: white; }
        .btn-za { background: var(--s); color: white; }
        .btn-przeciw { background: var(--d); color: white; }
        .btn-wstrzymuje { background: #f59e0b; color: white; }
        .btn:disabled { opacity: 0.5; filter: grayscale(1); }
        input { width: 100%; padding: 18px; border-radius: 18px; border: 2px solid #e2e8f0; text-align: center; font-size: 18px; box-sizing: border-box; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginArea" class="card" style="text-align: center; margin-top: 50px;">
            <h1 style="letter-spacing:-2px;">@mperek.</h1>
            <input type="text" id="accessCode" placeholder="KOD DOSTƒòPU">
            <button class="btn btn-main" style="margin-top:20px;" onclick="zaloguj()">ZALOGUJ</button>
        </div>

        <div id="profileArea" style="display:none;">
            <div class="id-card">
                <h2 id="userNameDisplay">-</h2>
                <p id="userPosDisplay" style="opacity:0.8; font-size:13px;"></p>
            </div>
            <button class="btn btn-main" style="background:var(--s);" onclick="wejdzNaSesje()">DO≈ÅƒÑCZ DO SESJI</button>
            <button class="btn" style="background:none; color:#94a3b8;" onclick="wyloguj()">Wyloguj</button>
        </div>

        <div id="voteArea" style="display:none;">
            <div class="card">
                <p id="activeUser" style="font-weight:800; color:var(--p); font-size:12px;"></p>
                <h2 id="vTitle" style="text-align:center;">Czekam...</h2>
                <div id="btns"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-main" onclick="zglosSie()">üñê G≈ÅOS</button>
                <button class="btn" style="background:#a855f7; color:white;" onclick="document.getElementById('wniosekModal').style.display='flex'">üìù WNIOSEK</button>
            </div>
        </div>
    </div>

    <div id="wniosekModal" class="modal">
        <div style="background:white; padding:30px; border-radius:24px; width:80%;">
            <h3>Wniosek</h3>
            <textarea id="trescWniosku" style="width:100%; height:80px;"></textarea>
            <button class="btn btn-main" onclick="wyslijWniosek()">WY≈öLIJ</button>
            <button onclick="document.getElementById('wniosekModal').style.display='none'">Zamknij</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM", authDomain: "votelive-f469d.firebaseapp.com", projectId: "votelive-f469d", appId: "1:959356764271:web:76f0284a0a1ce6e9874d9a" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "ankiet", "vote");

        let myCode = localStorage.getItem("rCode");
        let myData = null;

        if(myCode) init();

        async function init() {
            const snap = await getDoc(doc(db, "kody_dostepu", myCode));
            if(!snap.exists()) return wyloguj();
            myData = snap.data();
            document.getElementById('loginArea').style.display = "none";
            document.getElementById('profileArea').style.display = "block";
            document.getElementById('userNameDisplay').innerText = myData.imie + " " + myData.nazwisko;
            document.getElementById('userPosDisplay').innerText = myData.stanowisko;

            onSnapshot(docRef, s => {
                if(s.data().status === "reset_wszystkich") {
                    document.getElementById('voteArea').style.display = "none";
                    document.getElementById('profileArea').style.display = "block";
                }
            });
        }

        window.zaloguj = async () => {
            const c = document.getElementById('accessCode').value.trim();
            const snap = await getDoc(doc(db, "kody_dostepu", c));
            if(snap.exists()) { localStorage.setItem("rCode", c); location.reload(); }
        };

        window.wejdzNaSesje = async () => {
            const name = myData.imie + " " + myData.nazwisko;
            await updateDoc(docRef, { obecni: arrayUnion(name) });
            document.getElementById('profileArea').style.display = "none";
            document.getElementById('voteArea').style.display = "block";
            document.getElementById('activeUser').innerText = name;
            startSync();
        };

        function startSync() {
            onSnapshot(docRef, async snap => {
                const d = snap.data();
                const div = document.getElementById('btns');
                const safeName = (myData.imie + "_" + myData.nazwisko).replace(/\s/g, "_");
                
                const rSnap = await getDoc(doc(db, "kody_dostepu", myCode));
                if(rSnap.data().lastSessionID !== d.sessionID) {
                    document.getElementById('vTitle').innerText = "Czekaj na akceptacjƒô...";
                    div.innerHTML = ""; return;
                }

                if(d.status === "otwarte") {
                    document.getElementById('vTitle').innerText = d.tytul;
                    div.innerHTML = "";
                    const juz = d.lista_glosow && d.lista_glosow[safeName];

                    if(d.typ === "standard") {
                        ["ZA", "PRZECIW", "WSTRZYMA≈ÅO SIƒò"].forEach(o => {
                            const b = document.createElement('button'); b.innerText = o;
                            b.className = `btn ${o=='ZA'?'btn-za':o=='PRZECIW'?'btn-przeciw':'btn-wstrzymuje'}`;
                            if(juz) b.disabled = true;
                            b.onclick = () => updateDoc(docRef, { [`wyniki.${o}`]: increment(1), [`lista_glosow.${safeName}`]: o });
                            div.appendChild(b);
                        });
                    } else {
                        (d.opcjeGlosowania || []).forEach(o => {
                            const b = document.createElement('button'); b.innerText = o;
                            b.className = "btn btn-main"; if(juz) b.disabled = true;
                            b.onclick = () => updateDoc(docRef, { [`lista_glosow.${safeName}`]: o });
                            div.appendChild(b);
                        });
                    }
                } else {
                    document.getElementById('vTitle').innerText = "Oczekiwanie...";
                    div.innerHTML = "";
                }
            });
        }

        window.zglosSie = () => updateDoc(docRef, { rece: arrayUnion(myData.imie + " " + myData.nazwisko) });
        window.wyslijWniosek = async () => {
            await updateDoc(docRef, { wnioski: arrayUnion({ radny: myData.imie + " " + myData.nazwisko, tresc: document.getElementById('trescWniosku').value, czas: new Date().toLocaleTimeString() }) });
            document.getElementById('wniosekModal').style.display='none';
        };
        window.wyloguj = () => { localStorage.clear(); location.reload(); };
    </script>
</body>
</html>
