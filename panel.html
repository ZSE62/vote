<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin @mperek</title>
    <style>
        :root { --p: #3498db; --s: #27ae60; --d: #e74c3c; --dark: #2c3e50; --bg: #f8f9fa; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 320px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 25px; background: var(--dark); color: white; text-align: center; }
        .main { flex: 1; padding: 25px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .full { grid-column: span 2; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        .btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-blue { background: var(--p); color: white; }
        .btn-green { background: var(--s); color: white; }
        .btn-red { background: var(--d); color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th { text-align: left; padding: 10px; background: #f4f4f4; border-bottom: 2px solid #eee; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .badge { padding: 3px 7px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .online { background: #e8f5e9; color: #2e7d32; }
    </style>
</head>
<body>
    <div id="overlay" style="position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:100; display:flex; flex-direction:column; justify-content:center; align-items:center; display:none;">
        <h1>@mperek.</h1>
        <button class="btn btn-green" style="width:250px" onclick="otworzSesje()">ROZPOCZNIJ NOWƒÑ SESJƒò</button>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h1 style="margin:0; font-size:24px;">Admin.</h1>
        </div>
        <div style="padding: 20px;">
            <div class="card" style="margin-bottom: 20px;">
                <h4 style="margin:0 0 10px 0;">G≈ÅOSOWANIE</h4>
                <input type="text" id="vTitle" placeholder="Temat uchwa≈Çy">
                <button id="vBtn" class="btn btn-green" onclick="toggleVote()">START</button>
            </div>
            <div class="card">
                <h4 style="margin:0 0 10px 0;">KOLEJKA</h4>
                <div id="receList"></div>
            </div>
        </div>
        <div style="padding: 20px; margin-top: auto;">
            <button class="btn btn-red" onclick="zakonczSesje()">ZAMKNIJ SESJƒò</button>
        </div>
    </div>

    <div class="main">
        <div class="card">
            <h3>Obecno≈õƒá: <span id="qCount">0/0</span></h3>
            <div style="height:8px; background:#eee; border-radius:4px; overflow:hidden; margin: 10px 0;">
                <div id="qBar" style="height:100%; width:0%; background:var(--s); transition: 0.5s;"></div>
            </div>
            <div id="listObecni" style="font-size:12px; color:#666;"></div>
        </div>
        <div class="card">
            <h3>Wnioski Formalne</h3>
            <div id="listWnioski" style="max-height: 250px; overflow-y: auto;"></div>
        </div>
        <div class="card full">
            <h3>üë• Baza Radnych</h3>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                <input type="text" id="rCode" placeholder="Kod">
                <input type="text" id="rName" placeholder="Imiƒô i Nazwisko">
                <input type="text" id="rClass" placeholder="Klasa">
                <input type="text" id="rComm" placeholder="Komisja">
                <input type="text" id="rPos" placeholder="Stanowisko">
            </div>
            <button class="btn btn-blue" onclick="addRadny()">DODAJ RADNEGO</button>
            <table>
                <thead>
                    <tr><th>KOD</th><th>NAZWISKO</th><th>KLASA</th><th>FREKWENCJA</th><th>STATUS</th><th>AKCJA</th></tr>
                </thead>
                <tbody id="radniTable"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc, collection, getDocs, deleteDoc, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM", authDomain: "votelive-f469d.firebaseapp.com", projectId: "votelive-f469d", appId: "1:959356764271:web:76f0284a0a1ce6e9874d9a" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "ankiet", "vote");

        onSnapshot(docRef, async snap => {
            const d = snap.data();
            document.getElementById('overlay').style.display = d.status === "reset_wszystkich" ? "flex" : "none";
            document.getElementById('vBtn').innerText = d.status === "otwarte" ? "ZAMKNIJ" : "START";
            
            const kody = await getDocs(collection(db, "kody_dostepu"));
            document.getElementById('qCount').innerText = `${d.obecni?.length || 0}/${kody.size}`;
            document.getElementById('qBar').style.width = ((d.obecni?.length || 0)/kody.size*100) + "%";

            document.getElementById('receList').innerHTML = (d.rece || []).map(r => `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">${r} <button onclick="delH('${r}')" style="color:green; border:none; background:none; cursor:pointer;">OK</button></div>`).join('');
            document.getElementById('listWnioski').innerHTML = (d.wnioski || []).map(w => `<div style="border-bottom:1px solid #eee; padding:10px;"><small>${w.radny}</small><br><b>${w.tresc}</b></div>`).join('');
            document.getElementById('listObecni').innerHTML = (d.obecni || []).join(', ');
        });

        onSnapshot(collection(db, "kody_dostepu"), s => {
            const tbody = document.getElementById('radniTable'); tbody.innerHTML = "";
            s.forEach(d => {
                const r = d.data();
                const fr = r.sesjeWszystkie > 0 ? Math.round((r.sesjeObecne/r.sesjeWszystkie)*100) : 100;
                tbody.innerHTML += `<tr>
                    <td>${d.id}</td><td>${r.nazwisko}</td><td>${r.klasa}</td><td>${fr}% (${r.sesjeObecne || 0})</td>
                    <td>${r.zalogowany ? '<span class="badge online">W sesji</span>' : '-'}</td>
                    <td><button onclick="remR('${d.id}')" style="color:red; border:none; background:none; cursor:pointer;">Usu≈Ñ</button></td>
                </tr>`;
            });
        });

        window.otworzSesje = async () => {
            const newID = Date.now().toString();
            const kody = await getDocs(collection(db, "kody_dostepu"));
            for (const d of kody.docs) {
                await updateDoc(doc(db, "kody_dostepu", d.id), { sesjeWszystkie: increment(1), zalogowany: false });
            }
            await updateDoc(docRef, { status: "logowanie", sessionID: newID, obecni: [], rece: [], wnioski: [], wyniki: {}, lista_glosow: {} });
        };

        window.toggleVote = async () => {
            const s = await getDoc(docRef);
            if(s.data().status === "otwarte") updateDoc(docRef, { status: "zamkniete" });
            else updateDoc(docRef, { status: "otwarte", tytul: document.getElementById('vTitle').value || "G≈Çosowanie", wyniki: {"ZA":0, "PRZECIW":0, "WSTRZYMA≈ÅO SIƒò":0}, lista_glosow: {} });
        };

        window.zakonczSesje = async () => {
            if(!confirm("Zako≈Ñczyƒá sesjƒô?")) return;
            const kody = await getDocs(collection(db, "kody_dostepu"));
            kody.forEach(d => updateDoc(doc(db, "kody_dostepu", d.id), { zalogowany: false }));
            await updateDoc(docRef, { status: "reset_wszystkich" });
        };

        window.addRadny = () => {
            const c = document.getElementById('rCode').value;
            setDoc(doc(db, "kody_dostepu", c), {
                nazwisko: document.getElementById('rName').value,
                klasa: document.getElementById('rClass').value,
                komisja: document.getElementById('rComm').value,
                stanowisko: document.getElementById('rPos').value,
                sesjeObecne: 0, sesjeWszystkie: 0, zalogowany: false
            });
        };
        window.remR = (id) => deleteDoc(doc(db, "kody_dostepu", id));
        window.delH = (r) => updateDoc(docRef, { rece: arrayRemove(r) });
    </script>
</body>
</html>
