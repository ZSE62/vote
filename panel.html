<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>@mperek. | Panel Administratora</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --p: #4f46e5; --s: #10b981; --d: #ef4444; --dark: #0f172a; --bg: #f1f5f9; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* EKRAN POWITALNY */
        #welcomeScreen { position: fixed; inset: 0; background: var(--dark); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .welcome-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; width: 100%; max-width: 800px; padding: 40px; }
        .welcome-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 40px; border-radius: 32px; text-align: center; cursor: pointer; transition: 0.3s; }
        .welcome-card:hover { background: rgba(255,255,255,0.1); transform: translateY(-10px); border-color: var(--p); }
        
        /* LAYOUT */
        .sidebar { width: 340px; background: var(--dark); color: white; padding: 30px; display: flex; flex-direction: column; }
        .main { flex: 1; padding: 40px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .card { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .full { grid-column: span 2; }
        
        .btn { padding: 14px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; width: 100%; margin-bottom: 10px; font-family: inherit; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; }
        .btn-d { background: var(--d); color: white; }
        input { padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 15px; margin-bottom: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; font-size: 11px; color: #64748b; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="welcomeScreen">
        <h1 style="font-size: 48px; letter-spacing: -3px; margin-bottom: 10px;">@mperek.</h1>
        <div class="welcome-grid">
            <div class="welcome-card" onclick="nowaSesja()">
                <div style="font-size: 50px;">üöÄ</div>
                <h2>Zacznij sesjƒô</h2>
                <p style="font-size: 14px; color: #94a3b8;">Uruchom system i listƒô obecno≈õci</p>
            </div>
            <div class="welcome-card" onclick="pokazBaze()">
                <div style="font-size: 50px;">üóÇÔ∏è</div>
                <h2>Radni (Baza)</h2>
                <p style="font-size: 14px; color: #94a3b8;">ZarzƒÖdzaj kodami i danymi</p>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <h2 style="letter-spacing:-2px; margin-top:0;">@mperek.</h2>
        <div id="sideContent">
            <input type="text" id="vTitle" placeholder="Temat g≈Çosowania...">
            <button id="vBtn" class="btn btn-s" onclick="toggleVote()">START G≈ÅOSOWANIA</button>
            <div id="results" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; font-size:14px; margin-top:10px;"></div>
            <div style="margin-top: auto; padding-top: 40px;">
                <button class="btn btn-d" onclick="koniecSesji()">KONIEC SESJI</button>
            </div>
        </div>
    </div>

    <div class="main">
        <div id="sessionModule" class="full" style="display: contents;">
            <div class="card">
                <h3>üë• Obecni i Wyj≈õcia</h3>
                <div id="presenceList"></div>
            </div>
            <div class="card">
                <h3>üñê Kolejka i üìù Wnioski</h3>
                <div id="handList"></div>
                <div id="wnioskiList" style="margin-top:20px;"></div>
            </div>
        </div>

        <div id="databaseModule" class="card full hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>üóÇ Baza Radnych</h3>
                <button onclick="zamknijBaze()" style="background:none; border:none; cursor:pointer; color:var(--d); font-weight:800;">ZAMKNIJ X</button>
            </div>
            <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-bottom:15px;">
                <input type="text" id="rCode" placeholder="Kod">
                <input type="text" id="rName" placeholder="Nazwisko">
                <input type="text" id="rClass" placeholder="Klasa">
                <input type="text" id="rComm" placeholder="Komisja">
                <input type="text" id="rPos" placeholder="Stanowisko">
            </div>
            <button class="btn btn-p" onclick="dodajRadnego()">DODAJ RADNEGO</button>
            <table>
                <thead><tr><th>KOD</th><th>NAZWISKO</th><th>FREKWENCJA</th><th>AKCJA</th></tr></thead>
                <tbody id="radniTable"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc, collection, getDocs, deleteDoc, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM", authDomain: "votelive-f469d.firebaseapp.com", projectId: "votelive-f469d", appId: "1:959356764271:web:76f0284a0a1ce6e9874d9a" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "ankiet", "vote");

        onSnapshot(docRef, async s => {
            const d = s.data();
            if(!d) return;

            if(d.status === "reset_wszystkich") {
                document.getElementById('welcomeScreen').classList.remove('hidden');
            } else {
                document.getElementById('welcomeScreen').classList.add('hidden');
            }

            document.getElementById('vBtn').innerText = d.status === "otwarte" ? "ZAMKNIJ G≈ÅOSOWANIE" : "START G≈ÅOSOWANIA";
            
            if(d.wyniki) {
                document.getElementById('results').innerHTML = `
                    <p>ZA: <b>${d.wyniki.ZA}</b> | PRZECIW: <b>${d.wyniki.PRZECIW}</b> | WSTRZ: <b>${d.wyniki["WSTRZYMA≈ÅO SIƒò"]}</b></p>
                `;
            }

            const radni = await getDocs(collection(db, "kody_dostepu"));
            const presDiv = document.getElementById('presenceList'); presDiv.innerHTML = "";
            
            (d.obecni || []).forEach(nazwisko => {
                let rData = null; let rID = null;
                radni.forEach(rs => { if(rs.data().nazwisko === nazwisko) { rData = rs.data(); rID = rs.id; }});
                const zaliczone = rData && rData.lastSessionID === d.sessionID;
                const chceWyjsc = d.pro≈õby_wyjscie && d.pro≈õby_wyjscie.includes(nazwisko);

                presDiv.innerHTML += `
                    <div class="user-row">
                        <span>${nazwisko} ${chceWyjsc ? '‚ö†Ô∏è' : ''}</span>
                        <div>
                            ${!zaliczone ? `<button onclick="window.zalicz('${rID}', '${d.sessionID}')" class="btn-s" style="width:auto; padding:5px;">ZALICZ</button>` : '‚úÖ'}
                            ${chceWyjsc ? `<button onclick="window.wypusc('${nazwisko}')" class="btn-d" style="width:auto; padding:5px;">WYPU≈öƒÜ</button>` : ''}
                        </div>
                    </div>`;
            });

            document.getElementById('handList').innerHTML = (d.rece || []).map(r => `<div class="user-row"><span>üñê ${r}</span><button onclick="window.delH('${r}')">OK</button></div>`).join('');
            document.getElementById('wnioskiList').innerHTML = (d.wnioski || []).map(w => `<div style="font-size:12px; margin-bottom:5px;"><b>${w.radny}:</b> ${w.tresc}</div>`).join('');
        });

        onSnapshot(collection(db, "kody_dostepu"), s => {
            const tbody = document.getElementById('radniTable'); tbody.innerHTML = "";
            s.forEach(d => {
                const r = d.data();
                const f = r.sesjeWszystkie > 0 ? Math.round((r.sesjeObecne/r.sesjeWszystkie)*100) : 100;
                tbody.innerHTML += `<tr><td>${d.id}</td><td>${r.nazwisko}</td><td>${f}%</td><td><button onclick="window.remR('${d.id}')">X</button></td></tr>`;
            });
        });

        window.pokazBaze = () => {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('databaseModule').classList.remove('hidden');
        };

        window.zamknijBaze = () => {
            getDoc(docRef).then(s => {
                if(s.data().status === "reset_wszystkich") document.getElementById('welcomeScreen').classList.remove('hidden');
                document.getElementById('databaseModule').classList.add('hidden');
            });
        };

        window.nowaSesja = async () => {
            const newID = Date.now().toString();
            const radni = await getDocs(collection(db, "kody_dostepu"));
            radni.forEach(r => updateDoc(doc(db, "kody_dostepu", r.id), { sesjeWszystkie: increment(1) }));
            await updateDoc(docRef, { status: "logowanie", sessionID: newID, obecni: [], pro≈õby_wyjscie: [], rece: [], wnioski: [], wyniki: {ZA:0, PRZECIW:0, "WSTRZYMA≈ÅO SIƒò":0}, lista_glosow: {} });
        };

        window.koniecSesji = async () => {
            if(confirm("Zako≈Ñczyƒá sesjƒô? Radni wr√≥cƒÖ do profili.")) {
                await updateDoc(docRef, { status: "reset_wszystkich", obecni: [], pro≈õby_wyjscie: [] });
            }
        };

        window.toggleVote = async () => {
            const s = await getDoc(docRef);
            if(s.data().status === "otwarte") await updateDoc(docRef, { status: "zamkniete" });
            else await updateDoc(docRef, { status: "otwarte", tytul: document.getElementById('vTitle').value || "G≈Çosowanie", wyniki: {ZA:0, PRZECIW:0, "WSTRZYMA≈ÅO SIƒò":0}, lista_glosow: {} });
        };

        window.zalicz = async (id, sID) => { await updateDoc(doc(db, "kody_dostepu", id), { sesjeObecne: increment(1), lastSessionID: sID }); };
        window.wypusc = async (nazwisko) => { await updateDoc(docRef, { obecni: arrayRemove(nazwisko), pro≈õby_wyjscie: arrayRemove(nazwisko) }); };
        window.dodajRadnego = () => {
            const c = document.getElementById('rCode').value;
            setDoc(doc(db, "kody_dostepu", c), {
                nazwisko: document.getElementById('rName').value, klasa: document.getElementById('rClass').value,
                komisja: document.getElementById('rComm').value, stanowisko: document.getElementById('rPos').value,
                sesjeObecne: 0, sesjeWszystkie: 0, zalogowany: false, lastSessionID: ""
            });
        };
        window.remR = (id) => deleteDoc(doc(db, "kody_dostepu", id));
        window.delH = (r) => updateDoc(docRef, { rece: arrayRemove(r) });
    </script>
</body>
</html>
