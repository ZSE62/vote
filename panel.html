<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel ProwadzƒÖcego | @mperek.</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --p: #4f46e5; --s: #10b981; --d: #ef4444; --dark: #0f172a; --bg: #f1f5f9; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Dashboard - 3 kafelki */
        #dashboard { position: fixed; inset: 0; background: var(--dark); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .welcome-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 90%; max-width: 1000px; }
        .welcome-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 32px; text-align: center; cursor: pointer; transition: 0.3s; }
        .welcome-card:hover { background: rgba(255,255,255,0.1); transform: translateY(-5px); }

        /* Uk≈Çad g≈Ç√≥wny */
        .sidebar { width: 350px; background: var(--dark); color: white; padding: 25px; display: flex; flex-direction: column; overflow-y: auto; }
        .main { flex: 1; padding: 30px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; border-radius: 24px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .full { grid-column: span 2; }
        .hidden { display: none !important; }

        /* Elementy UI */
        .btn { padding: 12px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; font-family: inherit; margin-bottom: 5px; }
        .btn-p { background: var(--p); color: white; width: 100%; }
        .btn-s { background: var(--s); color: white; }
        .btn-d { background: var(--d); color: white; }
        input, select { padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }

        /* Listy radnych */
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #f8fafc; border-radius: 14px; margin-bottom: 8px; border: 1px solid #e2e8f0; }
        .hand-icon { font-size: 20px; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: #64748b; font-size: 11px; border-bottom: 2px solid #f1f5f9; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
    </style>
</head>
<body>

    <div id="dashboard">
        <h1 style="font-size: 40px; letter-spacing: -2px; margin-bottom: 40px;">@mperek.</h1>
        <div class="welcome-grid">
            <div class="welcome-card" onclick="startNewSession()">
                <div style="font-size: 40px;">üó≥Ô∏è</div>
                <h3>Nowa Sesja</h3>
                <p style="color: #94a3b8; font-size: 12px;">Prowadzenie obrad na ≈ºywo</p>
            </div>
            <div class="welcome-card" onclick="showView('archiveView')">
                <div style="font-size: 40px;">üìÇ</div>
                <h3>Archiwum</h3>
                <p style="color: #94a3b8; font-size: 12px;">Raporty i wyniki historyczne</p>
            </div>
            <div class="welcome-card" onclick="showView('databaseView')">
                <div style="font-size: 40px;">üë•</div>
                <h3>Baza Radnych</h3>
                <p style="color: #94a3b8; font-size: 12px;">ZarzƒÖdzanie kodami i danymi</p>
            </div>
        </div>
    </div>

    <div id="sidebar" class="sidebar hidden">
        <button class="btn btn-d" onclick="location.reload()" style="margin-bottom:20px;">Wr√≥ƒá do Menu</button>
        <small style="color: #94a3b8; font-weight: 800;">KONTROLA G≈ÅOSOWANIA</small>
        <div class="card" style="background: rgba(255,255,255,0.05); color: white; border: none; margin: 10px 0;">
            <input type="text" id="vTitle" placeholder="Temat punktu obrad...">
            <select id="vType">
                <option value="standard">ZA / PRZECIW / WSTRZ.</option>
                <option value="imienne">G≈Çosowanie imienne (Opcje)</option>
            </select>
            <button id="vBtn" class="btn btn-s" style="width:100%" onclick="toggleVote()">START G≈ÅOSOWANIA</button>
        </div>
        
        <div style="margin-top: 20px;">
            <small style="color: #94a3b8; font-weight: 800;">HISTORIA TEJ SESJI</small>
            <div id="sessionLog" style="font-size: 12px; margin-top:10px;"></div>
        </div>
        
        <button class="btn btn-d" style="margin-top:auto;" onclick="endFullSession()">ZAKO≈ÉCZ SESJƒò</button>
    </div>

    <div id="sessionView" class="main hidden">
        <div class="card">
            <h3>‚åõ Poczekalnia (Do akceptacji)</h3>
            <div id="waitingList"></div>
        </div>
        <div class="card">
            <h3>üë• Obecni na sesji</h3>
            <div id="presenceList"></div>
        </div>
        <div class="card full">
            <h3>üñê Kolejka do g≈Çosu i üìù Wnioski</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div id="handsList"></div>
                <div id="wnioskiList"></div>
            </div>
        </div>
    </div>

    <div id="databaseView" class="main hidden full">
        <div class="card full">
            <h2>üë• ZarzƒÖdzanie Radnymi</h2>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;">
                <input type="text" id="rCode" placeholder="KOD (np. 101)">
                <input type="text" id="rImie" placeholder="Imiƒô">
                <input type="text" id="rNazwisko" placeholder="Nazwisko">
                <input type="text" id="rPos" placeholder="Stanowisko">
                <button class="btn btn-p" onclick="addCouncillor()">Dodaj</button>
            </div>
            <table id="councillorsTable">
                <thead><tr><th>KOD</th><th>NAZWISKO I IMIƒò</th><th>STANOWISKO</th><th>SESJE</th><th>AKCJA</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="archiveView" class="main hidden full">
        <div class="card full">
            <h2>üìÇ Archiwum Sesji</h2>
            <div id="archiveList"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, deleteDoc, collection, getDocs, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM", authDomain: "votelive-f469d.firebaseapp.com", projectId: "votelive-f469d", appId: "1:959356764271:web:76f0284a0a1ce6e9874d9a" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "ankiet", "vote");

        // Nawigacja
        window.showView = (viewId) => {
            document.getElementById('dashboard').classList.add('hidden');
            document.querySelectorAll('.main').forEach(v => v.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            if(viewId === 'sessionView') document.getElementById('sidebar').classList.remove('hidden');
        };

        // --- BAZA RADNYCH ---
        onSnapshot(collection(db, "kody_dostepu"), s => {
            const tbody = document.querySelector('#councillorsTable tbody');
            tbody.innerHTML = "";
            s.forEach(d => {
                const r = d.data();
                tbody.innerHTML += `<tr>
                    <td><b>${d.id}</b></td>
                    <td>${r.imie} ${r.nazwisko}</td>
                    <td>${r.stanowisko}</td>
                    <td>${r.sesjeObecne}/${r.sesjeWszystkie}</td>
                    <td><button onclick="window.deleteC('${d.id}')">Usu≈Ñ</button></td>
                </tr>`;
            });
        });

        window.addCouncillor = async () => {
            const id = document.getElementById('rCode').value;
            await setDoc(doc(db, "kody_dostepu", id), {
                imie: document.getElementById('rImie').value,
                nazwisko: document.getElementById('rNazwisko').value,
                stanowisko: document.getElementById('rPos').value,
                sesjeObecne: 0, sesjeWszystkie: 0, isOnline: false, lastActive: 0, wnioski: []
            });
            alert("Dodano.");
        };

        window.deleteC = async (id) => { if(confirm("UsunƒÖƒá?")) await deleteDoc(doc(db, "kody_dostepu", id)); };

        // --- SESJA NA ≈ªYWO ---
        window.startNewSession = async () => {
            if(!confirm("RozpoczƒÖƒá nowƒÖ sesjƒô? Spowoduje to naliczenie frekwencji radnym.")) return;
            const sid = "SES_" + Date.now();
            // Zwiƒôkszamy licznik wszystkich sesji ka≈ºdemu radnemu
            const rSnap = await getDocs(collection(db, "kody_dostepu"));
            rSnap.forEach(r => updateDoc(doc(db, "kody_dostepu", r.id), { sesjeWszystkie: increment(1) }));
            
            await updateDoc(docRef, { 
                status: "logowanie", sessionID: sid, statusy_radnych: {}, 
                poczekalnia_lista: {}, lista_glosow: {}, rece: [], wnioski: [], historia: [] 
            });
            showView('sessionView');
        };

        onSnapshot(docRef, s => {
            const d = s.data(); if(!d) return;

            // Poczekalnia
            const waitDiv = document.getElementById('waitingList'); waitDiv.innerHTML = "";
            Object.entries(d.poczekalnia_lista || {}).forEach(([code, info]) => {
                waitDiv.innerHTML += `<div class="user-row">
                    <span><b>${info.nazwa}</b> (${info.czas})</span>
                    <button class="btn-s" onclick="window.acceptR('${code}')">DOPU≈öƒÜ</button>
                </div>`;
            });

            // Obecni i G≈Çosy
            const presDiv = document.getElementById('presenceList'); presDiv.innerHTML = "";
            Object.entries(d.statusy_radnych || {}).forEach(([code, status]) => {
                if(status === "zaakceptowany") {
                    const glos = d.lista_glosow[code] ? `‚úÖ (${d.lista_glosow[code]})` : "‚è≥ brak g≈Çosu";
                    presDiv.innerHTML += `<div class="user-row">
                        <span>${code === d.activeSpeaker ? 'üé§' : ''} ${code} - ${glos}</span>
                        <button class="btn-d" style="padding:5px" onclick="window.kickR('${code}')">USU≈É</button>
                    </div>`;
                }
            });

            // Rƒôce i Wnioski
            document.getElementById('handsList').innerHTML = (d.rece || []).map(name => `
                <div class="user-row"><span class="hand-icon">üñê</span> ${name} 
                <button onclick="window.lowerHand('${name}')">OK</button></div>
            `).join('');

            document.getElementById('wnioskiList').innerHTML = (d.wnioski || []).map(w => `
                <div class="card" style="margin-bottom:10px; font-size:12px; border-left:4px solid var(--p)">
                    <b>${w.radny}</b>: ${w.tytul} <small>${w.czas}</small>
                </div>
            `).join('');

            document.getElementById('vBtn').innerText = d.status === "otwarte" ? "ZAMKNIJ G≈ÅOSOWANIE" : "START G≈ÅOSOWANIA";
        });

        window.acceptR = async (code) => {
            // Zwiƒôkszamy obecno≈õƒá radnemu
            await updateDoc(doc(db, "kody_dostepu", code), { sesjeObecne: increment(1) });
            // Akceptujemy w sesji
            await updateDoc(docRef, { 
                [`statusy_radnych.${code}`]: "zaakceptowany",
                [`poczekalnia_lista.${code}`]: deleteField() // Usuniƒôcie z poczekalni wymaga importu deleteField lub updateDoc z ca≈Çym obiektem
            });
            // Firestore hack: aby usunƒÖƒá klucz mapy bez deleteField, wysy≈Çamy null lub aktualizujemy listƒô
            const s = await getDoc(docRef);
            let p = s.data().poczekalnia_lista; delete p[code];
            await updateDoc(docRef, { poczekalnia_lista: p });
        };

        window.kickR = async (code) => {
            let s = await getDoc(docRef);
            let sr = s.data().statusy_radnych; delete sr[code];
            await updateDoc(docRef, { statusy_radnych: sr });
        };

        window.toggleVote = async () => {
            const s = await getDoc(docRef);
            const d = s.data();
            if(d.status === "otwarte") {
                const wynik = `ZA: ${d.wyniki.ZA}, PRZ: ${d.wyniki.PRZECIW}, WST: ${d.wyniki["WSTRZYMA≈ÅO SIƒò"]}`;
                await updateDoc(docRef, { 
                    status: "zamkniete", 
                    historia: arrayUnion({ tytul: d.tytul, wynik: wynik, czas: new Date().toLocaleTimeString() }) 
                });
            } else {
                await updateDoc(docRef, { 
                    status: "otwarte", tytul: document.getElementById('vTitle').value || "G≈Çosowanie",
                    wyniki: {ZA:0, PRZECIW:0, "WSTRZYMA≈ÅO SIƒò":0}, lista_glosow: {}
                });
            }
        };

        window.lowerHand = (name) => updateDoc(docRef, { rece: arrayRemove(name) });

        window.endFullSession = async () => {
            if(confirm("Zako≈Ñczyƒá sesjƒô i zarchiwizowaƒá?")) {
                const s = await getDoc(docRef);
                await setDoc(doc(db, "archiwum", s.data().sessionID), s.data());
                await updateDoc(docRef, { status: "reset_wszystkich", statusy_radnych: {} });
                location.reload();
            }
        };
    </script>
</body>
</html>
