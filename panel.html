<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin @mperek - ZarzƒÖdzanie SesjƒÖ</title>
    <style>
        :root { 
            --primary: #2980b9; --success: #27ae60; --danger: #e74c3c; 
            --dark: #2c3e50; --purple: #8e44ad; --bg: #f4f7f6; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Ekran startowy */
        #start-screen { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--bg); z-index: 1000; }
        
        /* Uk≈Çad g≈Ç√≥wny */
        .sidebar { width: 380px; background: white; border-right: 1px solid #ddd; padding: 20px; display: none; flex-direction: column; overflow-y: auto; }
        .main { flex: 1; padding: 20px; display: none; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 20px; overflow-y: auto; }
        
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        .scroll-area { flex: 1; overflow-y: auto; margin-top: 10px; border: 1px solid #f0f0f0; border-radius: 5px; padding: 5px; }
        
        h3 { margin: 0 0 10px 0; font-size: 16px; color: var(--dark); border-bottom: 2px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; }
        
        input, select { padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; width: 100%; box-sizing: border-box; }
        
        button { padding: 10px; margin: 5px 0; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        .btn-blue { background: var(--primary); color: white; width: 100%; }
        .btn-green { background: var(--success); color: white; width: 100%; }
        .btn-red { background: var(--danger); color: white; width: 100%; }
        .btn-purple { background: var(--purple); color: white; width: 100%; }
        
        /* Listy */
        .item { padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        .wniosek-item { background: #fdf2ff; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid var(--purple); font-size: 13px; }
        .del-btn { background: #fee; color: var(--danger); border: 1px solid #fcc; padding: 2px 6px; font-size: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 60px; margin: 0;">@mperek.</h1>
        <p style="color: #777; margin-bottom: 30px;">System Obs≈Çugi G≈Çosowa≈Ñ RSU ZSE</p>
        <button class="btn-green" style="width: 300px; padding: 20px;" onclick="otworzSesje()">ROZPOCZNIJ NOWƒÑ SESJƒò</button>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="card">
            <h3>Sterowanie G≈Çosowaniem</h3>
            <input type="text" id="tytul" placeholder="Temat uchwa≈Çy / punkt obrad">
            <button id="actionBtn" class="btn-green" onclick="toggleVote()">START G≈ÅOSOWANIA</button>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3>üñê Kolejka do g≈Çosu (Rƒôce)</h3>
            <div id="receList" class="scroll-area" style="min-height: 150px;"></div>
            <button class="btn-blue" style="font-size: 11px;" onclick="czyscRece()">OPU≈öƒÜ WSZYSTKIE RƒòCE</button>
        </div>

        <div class="card" style="margin-top: 20px; flex: 1;">
            <h3>Historia tej sesji</h3>
            <div id="historia" class="scroll-area"></div>
        </div>

        <button class="btn-red" onclick="zakonczSesje()">ZAMKNIJ SESJƒò & RAPORT</button>
    </div>

    <div class="main" id="main">
        <div class="card">
            <h3>Obecni (Kworum: <span id="qStatus">?</span>)</h3>
            <div class="scroll-area"><div id="listObecni"></div></div>
        </div>

        <div class="card">
            <h3>üìù Zg≈Çoszone Wnioski</h3>
            <div class="scroll-area"><div id="listWnioski"></div></div>
            <button class="btn-purple" style="font-size: 11px;" onclick="czyscWnioski()">WYCZY≈öƒÜ LISTƒò WNIOSK√ìW</button>
        </div>

        <div class="card" style="grid-column: span 2;">
            <h3>Baza Radnych (Edycja Sk≈Çadu)</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="newCode" placeholder="Kod" style="flex: 1;">
                <input type="text" id="newName" placeholder="Imiƒô i Nazwisko" style="flex: 2;">
                <button class="btn-blue" style="width: 120px;" onclick="dodajRadnego()">DODAJ</button>
            </div>
            <div class="scroll-area"><div id="listBaza"></div></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, collection, getDocs, deleteDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM",
            authDomain: "votelive-f469d.firebaseapp.com",
            projectId: "votelive-f469d",
            appId: "1:959356764271:web:76f0284a0a1ce6e9874d9a" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "ankiet", "vote");

        // --- OBS≈ÅUGA DANYCH NA ≈ªYWO ---
        onSnapshot(docRef, async (snap) => {
            const data = snap.data(); if(!data) return;
            const isClosed = data.status === "reset_wszystkich";

            document.getElementById('start-screen').style.display = isClosed ? "flex" : "none";
            document.getElementById('sidebar').style.display = isClosed ? "none" : "flex";
            document.getElementById('main').style.display = isClosed ? "none" : "grid";

            // Akcja przycisku g≈Çosowania
            const actionBtn = document.getElementById('actionBtn');
            actionBtn.innerText = data.status === "otwarte" ? "ZAKO≈ÉCZ G≈ÅOSOWANIE" : "START G≈ÅOSOWANIA";
            actionBtn.className = data.status === "otwarte" ? "btn-red" : "btn-green";

            // Kworum
            const kodySnap = await getDocs(collection(db, "kody_dostepu"));
            const l_max = kodySnap.size;
            const l_ob = data.obecni?.length || 0;
            document.getElementById('qStatus').innerText = `${l_ob}/${l_max}`;

            // Lista Obecnych
            const listOb = document.getElementById('listObecni');
            listOb.innerHTML = "";
            (data.obecni || []).forEach(n => {
                listOb.innerHTML += `<div class="item">${n} <button class="del-btn" onclick="usunObecnego('${n}')">Wyloguj</button></div>`;
            });

            // Kolejka do g≈Çosu (Rƒôce)
            const listR = document.getElementById('receList');
            listR.innerHTML = "";
            (data.rece || []).forEach((r, i) => {
                listR.innerHTML += `<div class="item"><b>${i+1}. ${r}</b> <button onclick="usunReke('${r}')">Udzielono</button></div>`;
            });

            // Lista Wniosk√≥w
            const listW = document.getElementById('listWnioski');
            listW.innerHTML = "";
            (data.wnioski || []).forEach(w => {
                listW.innerHTML += `<div class="wniosek-item"><small>${w.czas} - <b>${w.radny}</b></small><br>${w.tresc}</div>`;
            });
        });

        // Baza Radnych
        onSnapshot(collection(db, "kody_dostepu"), (s) => {
            const listB = document.getElementById('listBaza');
            listB.innerHTML = "";
            s.forEach(d => {
                listB.innerHTML += `<div class="item"><span><b>${d.id}</b> - ${d.data().nazwisko}</span> <button class="del-btn" onclick="usunZBazy('${d.id}')">Usu≈Ñ</button></div>`;
            });
        });

        // Historia
        onSnapshot(collection(db, "archiwum_sesji"), (s) => {
            const h = document.getElementById('historia'); h.innerHTML = "";
            s.forEach(d => {
                const res = Object.entries(d.data().wyniki || {}).map(([k,v]) => `${k}:${v}`).join(' | ');
                h.innerHTML += `<div style="font-size:11px; margin-bottom:5px; border-bottom:1px solid #eee;"><b>${d.data().tytul}</b><br>${res}</div>`;
            });
        });

        // --- FUNKCJE PRZYCISK√ìW ---
        window.otworzSesje = async () => {
            await updateDoc(docRef, { status: "logowanie", obecni: [], wyniki: {}, lista_glosow: {}, rece: [], wnioski: [], tytul: "Oczekiwanie" });
        };

        window.toggleVote = async () => {
            const s = await getDoc(docRef);
            if(s.data().status === "otwarte") {
                await updateDoc(docRef, { status: "zamkniete" });
                await setDoc(doc(collection(db, "archiwum_sesji")), { ...s.data() });
            } else {
                const t = document.getElementById('tytul').value || "G≈Çosowanie";
                await updateDoc(docRef, { tytul: t, status: "otwarte", wyniki: {"ZA":0, "PRZECIW":0, "WSTRZYMA≈ÅO SIƒò":0}, lista_glosow: {} });
            }
        };

        window.usunReke = async (n) => { await updateDoc(docRef, { rece: arrayRemove(n) }); };
        window.czyscRece = async () => { if(confirm("Opu≈õciƒá wszystkim rƒôce?")) await updateDoc(docRef, { rece: [] }); };
        window.czyscWnioski = async () => { if(confirm("Wyczy≈õciƒá listƒô wniosk√≥w?")) await updateDoc(docRef, { wnioski: [] }); };
        
        window.dodajRadnego = async () => {
            const c = document.getElementById('newCode').value;
            const n = document.getElementById('newName').value;
            if(c && n) { await setDoc(doc(db, "kody_dostepu", c), { nazwisko: n }); }
        };

        window.usunZBazy = async (id) => { if(confirm("UsunƒÖƒá radnego z systemu?")) await deleteDoc(doc(db, "kody_dostepu", id)); };
        window.usunObecnego = async (n) => { const s = await getDoc(docRef); await updateDoc(docRef, { obecni: s.data().obecni.filter(x => x !== n) }); };

        window.zakonczSesje = async () => {
            if(!confirm("Zako≈Ñczyƒá sesjƒô i pobraƒá raport?")) return;
            // Pobieranie raportu (uproszczone)
            const q = await getDocs(collection(db, "archiwum_sesji"));
            let txt = "RAPORT SESJI\n\n";
            q.forEach(d => { txt += `UCHWA≈ÅA: ${d.data().tytul}\nWYNIKI: ${JSON.stringify(d.data().wyniki)}\n\n`; });
            const blob = new Blob([txt], {type: 'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "raport.txt"; a.click();

            // Reset
            await updateDoc(docRef, { status: "reset_wszystkich", obecni: [], rece: [], wnioski: [] });
            q.forEach(async d => await deleteDoc(doc(db, "archiwum_sesji", d.id)));
        };
    </script>
</body>
</html>
