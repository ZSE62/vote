<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin @mperek</title>
    <style>
        :root { --primary: #2980b9; --success: #27ae60; --danger: #e74c3c; --dark: #2c3e50; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 350px; background: white; border-right: 1px solid #ddd; padding: 20px; display: flex; flex-direction: column; }
        .main { flex: 1; padding: 20px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .scroll { height: 200px; overflow-y: auto; border: 1px solid #eee; margin-top: 10px; border-radius: 8px; }
        .item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 13px; }
        .btn { padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: var(--danger); color: white; }
        #kworumBar { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        #kworumFill { height: 100%; width: 0%; transition: 0.5s; background: var(--success); }
    </style>
</head>
<body>
    <div id="start" style="position:fixed; inset:0; background:var(--bg); z-index:100; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1>@mperek.</h1>
        <button class="btn btn-green" style="width:300px; padding:20px;" onclick="otworzSesje()">ROZPOCZNIJ NOWƒÑ SESJƒò</button>
    </div>

    <div class="sidebar">
        <div class="card">
            <h3>G≈Çosowanie</h3>
            <input type="text" id="tytul" placeholder="Temat uchwa≈Çy" style="width:100%; padding:10px; box-sizing:border-box; margin-bottom:10px;">
            <button id="voteBtn" class="btn btn-green" onclick="toggleVote()">START G≈ÅOSOWANIA</button>
        </div>
        <div class="card" style="margin-top:20px;">
            <h3>üñê Kolejka do g≈Çosu</h3>
            <div id="listRece" class="scroll"></div>
        </div>
        <button class="btn btn-red" style="margin-top:auto" onclick="zakonczSesje()">ZAKO≈ÉCZ SESJƒò</button>
    </div>

    <div class="main">
        <div class="card">
            <h3>Obecno≈õƒá (<span id="qText">0/0</span>)</h3>
            <div id="kworumBar"><div id="kworumFill"></div></div>
            <div id="listObecni" class="scroll"></div>
        </div>
        <div class="card">
            <h3>üìù Wnioski</h3>
            <div id="listWnioski" class="scroll"></div>
        </div>
        <div class="card" style="grid-column: span 2;">
            <button class="btn" style="background:#eee" onclick="toggleBaza()">ZarzƒÖdzaj BazƒÖ Radnych ‚ñº</button>
            <div id="baza" style="display:none; margin-top:10px;">
                <input type="text" id="newC" placeholder="Kod"> <input type="text" id="newN" placeholder="Nazwisko">
                <button onclick="dodajR()">Dodaj</button>
                <div id="listBaza" class="scroll"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc, collection, getDocs, deleteDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM", authDomain: "votelive-f469d.firebaseapp.com", projectId: "votelive-f469d", appId: "1:959356764271:web:76f0284a0a1ce6e9874d9a" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "ankiet", "vote");

        onSnapshot(docRef, async snap => {
            const data = snap.data(); if(!data) return;
            document.getElementById('start').style.display = data.status === "reset_wszystkich" ? "flex" : "none";
            
            const vBtn = document.getElementById('voteBtn');
            vBtn.innerText = data.status === "otwarte" ? "ZATRZYMAJ G≈ÅOSOWANIE" : "START G≈ÅOSOWANIA";
            vBtn.className = data.status === "otwarte" ? "btn btn-red" : "btn btn-green";

            const kody = await getDocs(collection(db, "kody_dostepu"));
            const l_max = kody.size; const l_ob = data.obecni?.length || 0;
            document.getElementById('kworumFill').style.width = (l_ob/l_max*100) + "%";
            document.getElementById('qText').innerText = `${l_ob}/${l_max}`;

            document.getElementById('listObecni').innerHTML = (data.obecni || []).map(n => `<div class="item">${n}</div>`).join('');
            document.getElementById('listRece').innerHTML = (data.rece || []).map(r => `<div class="item">${r} <button onclick="usunR('${r}')">G≈Ços</button></div>`).join('');
            document.getElementById('listWnioski').innerHTML = (data.wnioski || []).map(w => `<div style="padding:5px; border-bottom:1px solid #eee; font-size:11px;"><b>${w.radny}</b>: ${w.tresc}</div>`).join('');
        });

        onSnapshot(collection(db, "kody_dostepu"), s => {
            document.getElementById('listBaza').innerHTML = "";
            s.forEach(d => { document.getElementById('listBaza').innerHTML += `<div class="item">${d.id} - ${d.data().nazwisko} <button onclick="delR('${d.id}')">X</button></div>`; });
        });

        window.otworzSesje = async () => await updateDoc(docRef, { status: "logowanie", obecni: [], rece: [], wnioski: [], wyniki: {}, lista_glosow: {} });
        window.toggleVote = async () => {
            const s = await getDoc(docRef);
            if(s.data().status === "otwarte") await updateDoc(docRef, { status: "zamkniete" });
            else await updateDoc(docRef, { status: "otwarte", tytul: document.getElementById('tytul').value || "G≈Çosowanie", wyniki: {"ZA":0, "PRZECIW":0, "WSTRZYMA≈ÅO SIƒò":0}, lista_glosow: {} });
        };
        window.usunR = async r => await updateDoc(docRef, { rece: arrayRemove(r) });
        window.zakonczSesje = async () => { if(confirm("Na pewno?")) await updateDoc(docRef, { status: "reset_wszystkich" }); };
        window.toggleBaza = () => { const b = document.getElementById('baza'); b.style.display = b.style.display === "none" ? "block" : "none"; };
        window.dodajR = async () => { await setDoc(doc(db, "kody_dostepu", document.getElementById('newC').value), { nazwisko: document.getElementById('newN').value }); };
        window.delR = async id => await deleteDoc(doc(db, "kody_dostepu", id));
    </script>
</body>
</html>
