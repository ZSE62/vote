<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel ProwadzƒÖcego | @mperek</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root { --primary: #4f46e5; --success: #10b981; --danger: #ef4444; --bg: #f8fafc; --dark-bg: #0f172a; --dark-card: rgba(255,255,255,0.05); }
body { font-family:'Plus Jakarta Sans',sans-serif; margin:0; display:flex; height:100vh; background:var(--bg); overflow:hidden; }
.sidebar { width:320px; background:var(--dark-bg); color:white; display:flex; flex-direction:column; padding:25px; }
.main { flex:1; padding:30px; overflow-y:auto; display:grid; grid-template-columns:1fr 1fr; gap:20px; background:var(--bg); }
.card { background:white; border-radius:24px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
.btn { padding:12px; border:none; border-radius:12px; font-weight:700; cursor:pointer; width:100%; margin-bottom:5px; font-family:inherit; }
.btn-primary { background:var(--primary); color:white; }
.btn-success { background:var(--success); color:white; }
.btn-danger { background:var(--danger); color:white; }
.hidden { display:none !important; }
.user-row { display:flex; justify-content:space-between; align-items:center; padding:12px; background:#f8fafc; border-radius:12px; margin-bottom:5px; color:#000; border:1px solid #e2e8f0; font-size:13px; }
input, select { padding:12px; border-radius:12px; border:1px solid #e2e8f0; width:100%; margin-bottom:10px; font-family:inherit; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th { text-align:left; padding:10px; font-size:11px; color:#64748b; text-transform:uppercase; }
td { padding:10px; border-top:1px solid #f1f5f9; color:#000; font-size:13px; }
</style>
</head>
<body>

<div class="sidebar">
    <h2 style="margin-bottom:20px;">@mperek Panel</h2>
    <button class="btn btn-danger" onclick="exitToMenu()">WYJD≈π DO MENU</button>
    <div class="card" style="background:var(--dark-card); color:white; margin-top:20px;">
        <input type="text" id="vTitle" placeholder="Temat punktu obrad...">
        <select id="vType" onchange="document.getElementById('customOpt').classList.toggle('hidden', this.value!='imienne')">
            <option value="standard">Standard (ZA/PRZ/WST)</option>
            <option value="imienne">Imienne (w≈Çasne)</option>
        </select>
        <input type="text" id="customOpt" class="hidden" placeholder="Opcje (po przecinku)">
        <button id="vBtn" class="btn btn-success" onclick="toggleVote()">START G≈ÅOSOWANIA</button>
    </div>
    <button class="btn btn-danger" style="margin-top:auto;" onclick="endFullSession()">ZAKO≈ÉCZ I ARCHIWIZUJ</button>
</div>

<div class="main hidden" id="sessionView">
    <div class="card">
        <h3>‚åõ Poczekalnia</h3>
        <div id="waitingList"></div>
    </div>
    <div class="card">
        <h3>üë• Obecni</h3>
        <div id="presenceList"></div>
    </div>
    <div class="card">
        <h3>üñê Rƒôce</h3>
        <div id="handsList"></div>
    </div>
    <div class="card">
        <h3>üìù Wnioski</h3>
        <div id="wnioskiList"></div>
    </div>
</div>

<div class="main hidden" id="databaseView" style="grid-template-columns:1fr;">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <button class="btn btn-danger" onclick="exitToMenu()" style="width:150px; margin:0;">POWR√ìT</button>
            <h2 style="margin:0;">Baza Radnych</h2>
        </div>
        <div style="display:grid; grid-template-columns: repeat(4,1fr); gap:10px; background:#f8fafc; padding:20px; border-radius:20px;">
            <input type="text" id="newCode" placeholder="KOD">
            <input type="text" id="newImie" placeholder="Imiƒô">
            <input type="text" id="newNazwisko" placeholder="Nazwisko">
            <button class="btn btn-primary" onclick="addRadny()" style="margin:0;">DODAJ</button>
        </div>
        <table>
            <thead><tr><th>KOD</th><th>IMIƒò I NAZWISKO</th><th>FREKWENCJA</th><th>STATUS</th><th>AKCJA</th></tr></thead>
            <tbody id="dbList"></tbody>
        </table>
    </div>
</div>

<div class="main hidden" id="archiveView" style="grid-template-columns:1fr;">
    <div class="card">
        <button class="btn btn-danger" onclick="exitToMenu()" style="width:200px;">POWR√ìT</button>
        <h2>Archiwum Sesji</h2>
        <div id="archContent"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc, collection, getDocs, arrayRemove, increment, deleteField, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig={ apiKey:"AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM", authDomain:"votelive-f469d.firebaseapp.com", projectId:"votelive-f469d", appId:"1:959356764271:web:76f0284a0a1ce6e9874d9a" };
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const docRef=doc(db,"ankiet","vote");

const curView=localStorage.getItem('panelView'); 
if(curView && curView!=='dashboard') showView(curView);

window.showView=(id)=>{
    localStorage.setItem('panelView',id);
    document.querySelectorAll('.main').forEach(el=>el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    if(id==='sessionView') document.querySelector('.sidebar').classList.remove('hidden');
    if(id==='archiveView') loadArchive();
    if(id==='databaseView') loadDatabase();
};

window.exitToMenu=()=>{ localStorage.setItem('panelView','dashboard'); location.reload(); };

window.startNewSession=async()=>{
    const rSnap=await getDocs(collection(db,"kody_dostepu"));
    rSnap.forEach(r=>updateDoc(doc(db,"kody_dostepu",r.id),{ sesjeWszystkie: increment(1) }));
    const sid="SESJA_"+Date.now();
    await updateDoc(docRef,{ status:"logowanie", statusy_radnych:{}, poczekalnia_lista:{}, activeSpeaker:"", sessionID:sid });
    showView('sessionView');
};

onSnapshot(docRef,s=>{
    const d=s.data(); if(!d) return;
    const waitList=document.getElementById('waitingList'); waitList.innerHTML="";
    Object.entries(d.poczekalnia_lista||{}).forEach(([code,info])=>{ waitList.innerHTML+=`<div class="user-row">${info.nazwa} <button onclick="accept('${code}')" class="btn btn-success" style="width:80px; margin:0;">OK</button></div>`; });

    const presList=document.getElementById('presenceList'); presList.innerHTML="";
    Object.entries(d.statusy_radnych||{}).forEach(([code,stat])=>{ if(stat==='zaakceptowany') presList.innerHTML+=`<div class="user-row">${code} <button onclick="kick('${code}')" class="btn btn-danger" style="width:80px; margin:0;">USU≈É</button></div>`; });

    document.getElementById('handsList').innerHTML=(d.rece||[]).map(n=>`<div class="user-row">${n} <button onclick="giveVoice('${n}')" class="btn btn-success" style="width:100px; margin:0;">DAJ G≈ÅOS</button></div>`).join('');
    document.getElementById('wnioskiList').innerHTML=(d.wnioski||[]).map(w=>`<div class="user-row"><b>${w.radny}</b>: ${w.tytul}</div>`).join('');

    document.getElementById('vBtn').innerText=d.status==='otwarte'?"ZAMKNIJ G≈ÅOSOWANIE":"START G≈ÅOSOWANIA";
});

window.accept=async(code)=>{ await updateDoc(doc(db,"kody_dostepu",code),{ sesjeObecne: increment(1) }); await updateDoc(docRef,{ [`statusy_radnych.${code}`]:"zaakceptowany", [`poczekalnia_lista.${code}`]:deleteField() }); };
window.kick=async(code)=>{ await updateDoc(docRef,{ [`statusy_radnych.${code}`]:deleteField() }); };
window.giveVoice=async(name)=>{ await updateDoc(docRef,{ activeSpeaker:name, rece:arrayRemove(name) }); };

window.toggleVote=async()=>{
    const d=(await getDoc(docRef)).data();
    if(d.status==='otwarte'){ await updateDoc(docRef,{ status:"zamkniete" }); }
    else{
        const type=document.getElementById('vType').value;
        const opts=type==='standard'?["ZA","PRZECIW","WSTRZYMA≈ÅO SIƒò"]:document.getElementById('customOpt').value.split(',');
        let w={}; opts.forEach(o=>w[o.trim()]=0);
        await updateDoc(docRef,{ status:"otwarte", tytul:document.getElementById('vTitle').value, opcjeGlosowania:opts.map(o=>o.trim()), wyniki:w, lista_glosow:{} });
    }
};

window.endFullSession=async()=>{
    if(!confirm("Zarchiwizowaƒá?")) return;
    const d=(await getDoc(docRef)).data();
    await setDoc(doc(db,"archiwum",d.sessionID),d);
    await updateDoc(docRef,{ status:"koniec", statusy_radnych:{}, poczekalnia_lista:{}, activeSpeaker:"", wnioski:[] });
    exitToMenu();
};

async function loadDatabase(){
    const snap=await getDocs(collection(db,"kody_dostepu"));
    const tbody=document.getElementById('dbList'); tbody.innerHTML="";
    snap.forEach(ds=>{
        const r=ds.data();
        const perc=r.sesjeWszystkie>0?Math.round((r.sesjeObecne/r.sesjeWszystkie)*100):100;
        tbody.innerHTML+=`<tr>
            <td><b>${ds.id}</b></td>
            <td>${r.imie} ${r.nazwisko}</td>
            <td>${perc}% (${r.sesjeObecne}/${r.sesjeWszystkie})</td>
            <td>${r.isOnline?'üü¢ Online':'‚ö™ Offline'}</td>
            <td><button onclick="delRadny('${ds.id}')" class="btn btn-danger" style="padding:5px 10px; font-size:10px;">USU≈É</button></td>
        </tr>`;
    });
}

window.addRadny=async()=>{
    const c=document.getElementById('newCode').value; if(!c) return;
    await setDoc(doc(db,"kody_dostepu",c),{ imie:document.getElementById('newImie').value, nazwisko:document.getElementById('newNazwisko').value, sesjeObecne:0, sesjeWszystkie:0, isOnline:false });
    loadDatabase();
};
window.delRadny=async(id)=>{ if(confirm("UsunƒÖƒá?")){ await deleteDoc(doc(db,"kody_dostepu",id)); loadDatabase(); } };

async function loadArchive(){
    const snap=await getDocs(collection(db,"archiwum"));
    const list=document.getElementById('archContent'); list.innerHTML="";
    snap.forEach(d=>{
        const data=d.data();
        list.innerHTML+=`<div class="card" style="margin-bottom:10px;">
            <b>ID: ${d.id}</b> | G≈Çosowa≈Ñ: ${(data.historia||[]).length} | Wnioski: ${(data.wnioski||[]).length}
        </div>`;
    });
}
</script>
</body>
</html>
