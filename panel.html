<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Administratora</title>
    <style>
        :root { --primary: #3498db; --success: #27ae60; --danger: #e74c3c; --dark: #2c3e50; }
        body { font-family: sans-serif; background: #f4f7f6; margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 350px; background: white; border-right: 1px solid #ddd; padding: 20px; display: flex; flex-direction: column; }
        .main { flex: 1; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow-y: auto; }
        button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
        .btn-vote { background: var(--success); color: white; height: 50px; }
        .btn-stop { background: var(--danger); color: white; }
        .status { padding: 10px; text-align: center; border-radius: 5px; margin-bottom: 10px; font-weight: bold; background: #eee; }
        .active { background: #d4edda; color: #155724; }
        .small-list { list-style: none; padding: 0; font-size: 13px; }
        .small-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .del { color: white; cursor: pointer; border: none; background: var(--danger); font-size: 10px; padding: 4px 8px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div id="st" class="status">SESJA ZAMKNIĘTA</div>
        <button id="openBtn" style="background:var(--primary); color:white" onclick="otworzSesje()">OTWÓRZ SESJĘ</button>
        
        <div id="ctrl" style="display:none; margin-top:20px">
            <h3>Głosowanie</h3>
            <input type="text" id="tytul" placeholder="Temat uchwały">
            <select id="tryb" onchange="document.getElementById('custom').style.display=this.value=='os'?'block':'none'">
                <option value="tn">ZA / PRZECIW / WSTRZYMAŁO SIĘ</option>
                <option value="os">LISTA WŁASNA</option>
            </select>
            <div id="custom" style="display:none"><input type="text" id="opcje" placeholder="Opcja 1, Opcja 2..."></div>
            <button id="actionBtn" class="btn-vote" onclick="toggleVote()">START GŁOSOWANIA</button>
        </div>

        <button style="margin-top:auto; background:none; border: 1px solid red; color:red" onclick="zakonczSesje()">ZAKOŃCZ SESJĘ & RAPORT</button>
    </div>

    <div class="main">
        <div class="card">
            <h3>Obecni (<span id="c">0</span>) <button onclick="toggleL()" id="lBtn" style="width:auto; float:right; font-size:10px; padding: 5px;">ZABLOKUJ</button></h3>
            <ul id="lO" class="small-list"></ul>
        </div>
        <div class="card">
            <h3>Baza Radnych</h3>
            <input type="text" id="nK" placeholder="Kod dostępu">
            <input type="text" id="nN" placeholder="Nazwisko i Imię">
            <button style="background:var(--dark); color:white" onclick="dodajK()">DODAJ RADNEGO</button>
            <hr>
            <ul id="lB" class="small-list"></ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM",
            authDomain: "votelive-f469d.firebaseapp.com",
            projectId: "votelive-f469d",
            storageBucket: "votelive-f469d.firebasestorage.app",
            messagingSenderId: "959356764271",
            appId: "1:959356764271:web:76f0284a0a1ce6e9874d9a" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "ankiet", "vote");
        let stat = "";

        onSnapshot(docRef, (snap) => {
            const data = snap.data(); if(!data) return;
            stat = data.status;
            document.getElementById('st').innerText = stat === "reset_wszystkich" ? "SESJA ZAMKNIĘTA" : "SESJA OTWARTA";
            document.getElementById('st').className = stat === "reset_wszystkich" ? "status" : "status active";
            document.getElementById('openBtn').style.display = stat === "reset_wszystkich" ? "block" : "none";
            document.getElementById('ctrl').style.display = stat === "reset_wszystkich" ? "none" : "block";
            
            const btn = document.getElementById('actionBtn');
            btn.innerText = stat === "otwarte" ? "ZAKOŃCZ GŁOSOWANIE" : "START GŁOSOWANIA";
            btn.className = stat === "otwarte" ? "btn-vote btn-stop" : "btn-vote";

            document.getElementById('c').innerText = data.obecni?.length || 0;
            document.getElementById('lBtn').innerText = data.lista_lock ? "ODBLOKUJ" : "ZABLOKUJ";
            const ul = document.getElementById('lO'); ul.innerHTML = "";
            (data.obecni || []).forEach(o => { ul.innerHTML += `<li>${o} <button class="del" onclick="usunO('${o}')">WYRZUĆ</button></li>`; });
        });

        onSnapshot(collection(db, "kody_dostepu"), (s) => {
            const ul = document.getElementById('lB'); ul.innerHTML = "";
            s.forEach(d => { ul.innerHTML += `<li><span><b>${d.id}</b>: ${d.data().nazwisko}</span> <button class="del" onclick="usunK('${d.id}')">USUŃ</button></li>`; });
        });

        window.otworzSesje = async () => { await updateDoc(docRef, { status: "logowanie", obecni: [], lista_lock: false, tytul: "Oczekiwanie" }); };

        window.toggleVote = async () => {
            if(stat === "otwarte") {
                const s = await getDoc(docRef);
                await updateDoc(docRef, { status: "zamkniete" });
                await setDoc(doc(collection(db, "archiwum_sesji")), { ...s.data(), czas: new Date().toLocaleString() });
            } else {
                const t = document.getElementById('tytul').value || "Głosowanie";
                let w = {};
                if(document.getElementById('tryb').value === 'tn') w = {"ZA":0, "PRZECIW":0, "WSTRZYMAŁO SIĘ":0};
                else document.getElementById('opcje').value.split(',').forEach(o => { if(o.trim()) w[o.trim().toUpperCase()] = 0; });
                await updateDoc(docRef, { tytul: t, wyniki: w, lista_glosow: {}, status: "otwarte", tryb: "reset" });
            }
        };

        window.dodajK = async () => {
            const k = document.getElementById('nK').value.trim(); const n = document.getElementById('nN').value.trim();
            if(k && n) { await setDoc(doc(db, "kody_dostepu", k), { nazwisko: n }); document.getElementById('nK').value=""; document.getElementById('nN').value=""; }
        };

        window.usunK = async (kodId) => {
            if(!confirm("Usunąć kod i wylogować radnego?")) return;
            const codeSnap = await getDoc(doc(db, "kody_dostepu", kodId));
            if(codeSnap.exists()) {
                const nazwisko = codeSnap.data().nazwisko;
                const voteSnap = await getDoc(docRef);
                const nowi = (voteSnap.data().obecni || []).filter(o => o !== nazwisko);
                await updateDoc(docRef, { obecni: nowi });
            }
            await deleteDoc(doc(db, "kody_dostepu", kodId));
        };

        window.usunO = async (n) => { const s = await getDoc(docRef); await updateDoc(docRef, { obecni: s.data().obecni.filter(o => o !== n) }); };
        window.toggleL = async () => { const s = await getDoc(docRef); await updateDoc(docRef, { lista_lock: !s.data().lista_lock }); };

        window.zakonczSesje = async () => {
            if(!confirm("Pobrać raport i zakończyć dzień?")) return;
            const q = await getDocs(collection(db, "archiwum_sesji"));
            let r = "PEŁNY RAPORT SESJI\n==================\n";
            q.forEach(d => {
                const data = d.data();
                r += `\nUCHWAŁA: ${data.tytul}\nCZAS: ${data.czas}\nWYNIKI: ${JSON.stringify(data.wyniki)}\nLISTA IMIENNA:\n`;
                Object.entries(data.lista_glosow || {}).forEach(([k,v]) => r += `- ${k}: ${v}\n`);
                r += "------------------\n";
            });
            const blob = new Blob([r], {type:'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "Raport_Dnia.txt"; a.click();
            await updateDoc(docRef, { status: "reset_wszystkich", obecni: [], lista_lock: false });
            q.forEach(async (d) => await deleteDoc(doc(db, "archiwum_sesji", d.id)));
        };
    </script>
</body>
</html>
