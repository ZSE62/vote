<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Sterowania</title>
    <style>
        body { font-family: sans-serif; background: #fdfdfd; color: #333; padding: 20px; }
        .box { max-width: 450px; margin: auto; background: white; padding: 25px; border-radius: 10px; border: 1px solid #ddd; }
        input, select, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; }
        button { background: #2980b9; color: white; font-weight: bold; cursor: pointer; border: none; }
        .stop { background: #d35400; }
        .reset { background: #c0392b; margin-top: 20px; }
        .counter { font-size: 1.5rem; text-align: center; margin: 15px 0; font-weight: bold; color: #27ae60; border: 2px solid #27ae60; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="box">
        <h2>Panel Sterowania</h2>
        <div class="counter">ODDANYCH GŁOSÓW: <span id="liveCount">0</span></div>
        
        <input type="text" id="tytul" placeholder="Temat głosowania">
        <select id="tryb" onchange="document.getElementById('osobyDiv').style.display = this.value=='osoby'?'block':'none'">
            <option value="tak_nie">ZA / PRZECIW / WSTRZYMAŁO SIĘ</option>
            <option value="osoby">LISTA WŁASNA (oddziel przecinkiem)</option>
        </select>
        <div id="osobyDiv" style="display:none;"><input type="text" id="listaOsob" placeholder="Opcja 1, Opcja 2..."></div>

        <button onclick="uruchom()">START GŁOSOWANIA</button>
        <button class="stop" onclick="zamknij()">ZAMKNIJ I POBIERZ RAPORT</button>
        <button class="reset" onclick="resetuj()">CAŁKOWITY RESET</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM",
            authDomain: "votelive-f469d.firebaseapp.com",
            projectId: "votelive-f469d",
            storageBucket: "votelive-f469d.firebasestorage.app",
            messagingSenderId: "959356764271",
            appId: "1:959356764271:web:76f0284a0a1ce6e9874d9a" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "ankiet", "vote");

        onSnapshot(docRef, (snap) => {
            const data = snap.data();
            if(data && data.wyniki) {
                const total = Object.values(data.wyniki).reduce((a, b) => a + b, 0);
                document.getElementById('liveCount').innerText = total;
            } else { document.getElementById('liveCount').innerText = "0"; }
        });

        window.uruchom = async () => {
            const t = document.getElementById('tytul').value || "Głosowanie";
            const tryb = document.getElementById('tryb').value;
            let w = tryb === 'tak_nie' ? { "ZA": 0, "PRZECIW": 0, "WSTRZYMAŁO SIĘ": 0 } : {};
            if(tryb === 'osoby') document.getElementById('listaOsob').value.split(',').forEach(o => { if(o.trim()) w[o.trim()] = 0; });
            await setDoc(docRef, { tytul: t, wyniki: w, tryb: tryb, status: "otwarte" });
            alert("Głosowanie uruchomione!");
        };

        window.zamknij = async () => {
            await updateDoc(docRef, { status: "zamkniete" });
            const snap = await getDoc(docRef);
            const data = snap.data();
            const teraz = new Date();
            
            let tekst = `URZĘDOWY RAPORT Z GŁOSOWANIA\n`;
            tekst += `==========================================\n`;
            tekst += `TEMAT: ${data.tytul.toUpperCase()}\n`;
            tekst += `DATA: ${teraz.toLocaleDateString('pl-PL')}\n`;
            tekst += `GODZINA: ${teraz.toLocaleTimeString('pl-PL')}\n`;
            tekst += `==========================================\n\n`;
            tekst += `WYNIKI SZCZEGÓŁOWE:\n`;
            
            let total = 0;
            Object.entries(data.wyniki).forEach(([k, v]) => {
                tekst += `- ${k.padEnd(20)} : ${v} głosów\n`;
                total += v;
            });
            
            tekst += `\n------------------------------------------\n`;
            tekst += `SUMA WSZYSTKICH GŁOSÓW: ${total}\n`;
            tekst += `==========================================\n`;
            tekst += `Raport wygenerowany automatycznie.`;
            
            const blob = new Blob([tekst], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Raport_${data.tytul.replace(/\s+/g, '_')}_${teraz.getHours()}${teraz.getMinutes()}.txt`;
            a.click();
        };

        window.resetuj = async () => {
            if(confirm("Reset systemu wyczyści wyniki. Kontynuować?")) {
                await setDoc(docRef, { tytul: "Oczekiwanie...", wyniki: {}, tryb: "reset", status: "reset" });
            }
        };
    </script>
</body>
</html>

