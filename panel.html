<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Administratora</title>
    <style>
        :root { --primary: #3498db; --success: #27ae60; --danger: #e74c3c; --dark: #2c3e50; }
        body { font-family: sans-serif; background: #f4f7f6; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Ekran startowy */
        #start-screen { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; background: #f4f7f6; z-index: 100; }
        .btn-start-big { padding: 30px 60px; font-size: 24px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }

        /* Układ paneli */
        .sidebar { width: 320px; background: white; border-right: 1px solid #ddd; padding: 20px; display: none; flex-direction: column; }
        .main { flex: 1; padding: 20px; display: none; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .scroll-area { flex: 1; overflow-y: auto; margin-top: 10px; }

        /* Formularze */
        h3 { margin-top: 0; color: var(--dark); font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        input, select { padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        .input-short { width: 100%; max-width: 250px; } /* Zmniejszone pole nazwy */
        
        button { padding: 10px; margin: 5px 0; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-vote { background: var(--success); color: white; }
        .btn-stop { background: var(--danger); color: white; }
        .btn-add { background: var(--dark); color: white; }

        /* Styl listy radnych */
        .small-list { list-style: none; padding: 0; margin: 0; }
        .small-list li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 10px; 
            border-bottom: 1px solid #f9f9f9; 
            font-size: 13px; 
        }
        .small-list li:hover { background: #fcfcfc; }
        .radny-name { font-weight: 500; color: #333; }
        .radny-code { color: #888; font-family: monospace; background: #eee; padding: 2px 5px; border-radius: 3px; margin-right: 10px; }
        
        .del-mini { 
            width: auto; padding: 4px 8px; margin: 0;
            background: #fff0f0; color: var(--danger); 
            border: 1px solid #ffcccc; font-size: 10px; 
        }
        .del-mini:hover { background: var(--danger); color: white; }

        .hist-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 12px; }
        .hist-item b { color: var(--dark); }
    </style>
</head>
<body>
    <div id="start-screen"><button class="btn-start-big" onclick="otworzSesje()">OTWÓRZ SESJĘ</button></div>

    <div class="sidebar" id="sidebar">
        <div class="card" style="margin-bottom: 20px;">
            <h3>Nowe Głosowanie</h3>
            <label style="font-size: 0.8rem; color: #666;">Temat uchwały:</label>
            <input type="text" id="tytul" class="input-short" placeholder="Np. Uchwała nr 1">
            <select id="tryb">
                <option value="tn">ZA / PRZECIW / WSTRZYMAŁO SIĘ</option>
            </select>
            <button id="actionBtn" class="btn-vote" onclick="toggleVote()">START GŁOSOWANIA</button>
        </div>
        
        <div class="card" style="flex: 1;">
            <h3>Historia Sesji</h3>
            <div id="historia" class="scroll-area"></div>
        </div>

        <button style="background:none; border: 1px solid var(--danger); color: var(--danger); margin-top: 10px;" onclick="zakonczSesje()">ZAKOŃCZ SESJĘ & RAPORT</button>
    </div>

    <div class="main" id="main">
        <div class="card">
            <h3>Obecni Radni (<span id="c">0</span>)</h3>
            <div class="scroll-area">
                <ul id="lO" class="small-list"></ul>
            </div>
        </div>

        <div class="card">
            <h3>Baza Radnych</h3>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 5px;">
                <input type="text" id="nK" placeholder="Kod">
                <input type="text" id="nN" placeholder="Imię i Nazwisko">
            </div>
            <button class="btn-add" onclick="dodajK()">DODAJ RADNEGO</button>
            <div class="scroll-area" style="border-top: 1px solid #eee;">
                <ul id="lB" class="small-list"></ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM",
            authDomain: "votelive-f469d.firebaseapp.com",
            projectId: "votelive-f469d",
            storageBucket: "votelive-f469d.firebasestorage.app",
            messagingSenderId: "959356764271",
            appId: "1:959356764271:web:76f0284a0a1ce6e9874d9a" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "ankiet", "vote");

        onSnapshot(docRef, (snap) => {
            const data = snap.data(); if(!data) return;
            const closed = data.status === "reset_wszystkich";
            document.getElementById('start-screen').style.display = closed ? "flex" : "none";
            document.getElementById('sidebar').style.display = closed ? "none" : "flex";
            document.getElementById('main').style.display = closed ? "none" : "grid";

            const btn = document.getElementById('actionBtn');
            btn.innerText = data.status === "otwarte" ? "ZAKOŃCZ GŁOSOWANIE" : "START GŁOSOWANIA";
            btn.className = data.status === "otwarte" ? "btn-stop" : "btn-vote";

            document.getElementById('c').innerText = data.obecni?.length || 0;
            const ul = document.getElementById('lO'); ul.innerHTML = "";
            (data.obecni || []).forEach(o => { 
                ul.innerHTML += `<li><span class="radny-name">${o}</span> <button class="del-mini" onclick="usunO('${o}')">WYRZUĆ</button></li>`; 
            });
        });

        onSnapshot(collection(db, "kody_dostepu"), (s) => {
            const ul = document.getElementById('lB'); ul.innerHTML = "";
            s.forEach(d => { 
                ul.innerHTML += `<li><span><span class="radny-code">${d.id}</span><span class="radny-name">${d.data().nazwisko}</span></span> <button class="del-mini" onclick="usunK('${d.id}')">USUŃ</button></li>`; 
            });
        });

        onSnapshot(collection(db, "archiwum_sesji"), (s) => {
            const div = document.getElementById('historia'); div.innerHTML = "";
            s.forEach(d => { 
                const res = Object.entries(d.data().wyniki).map(([k,v]) => `${k}:${v}`).join(' ');
                div.innerHTML += `<div class="hist-item"><b>${d.data().tytul}</b><br>${res}</div>`; 
            });
        });

        window.otworzSesje = async () => { 
            await updateDoc(docRef, { status: "logowanie", obecni: [], wyniki: {}, lista_glosow: {}, tytul: "Oczekiwanie" }); 
        };

        window.toggleVote = async () => {
            const s = await getDoc(docRef);
            if(s.data().status === "otwarte") {
                await updateDoc(docRef, { status: "zamkniete" });
                await setDoc(doc(collection(db, "archiwum_sesji")), { ...s.data(), data_zakonczenia: new Date().toLocaleString() });
            } else {
                const t = document.getElementById('tytul').value || "Głosowanie";
                await updateDoc(docRef, { tytul: t, status: "otwarte", wyniki: {"ZA":0, "PRZECIW":0, "WSTRZYMAŁO SIĘ":0}, lista_glosow: {} });
            }
        };

        window.zakonczSesje = async () => {
            if(!confirm("Czy na pewno chcesz zakończyć sesję i pobrać raport?")) return;
            
            const q = await getDocs(collection(db, "archiwum_sesji"));
            let raport = "RAPORT Z SESJI GŁOSOWANIA\n" + "=".repeat(30) + "\n";
            
            q.forEach(d => {
                const data = d.data();
                raport += `\nTEMAT: ${data.tytul}\nDATA: ${data.data_zakonczenia || 'brak'}\n`;
                raport += `WYNIKI: ZA(${data.wyniki.ZA}) PRZECIW(${data.wyniki.PRZECIW}) WSTRZYMAŁO SIĘ(${data.wyniki['WSTRZYMAŁO SIĘ']})\n`;
                raport += "-".repeat(20) + "\nSZCZEGÓŁY GŁOSÓW:\n";
                Object.entries(data.lista_glosow || {}).forEach(([name, vote]) => {
                    raport += `${name}: ${vote}\n`;
                });
            });

            const blob = new Blob([raport], {type: 'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Raport_Sesja_${new Date().toLocaleDateString()}.txt`; a.click();

            await updateDoc(docRef, { status: "reset_wszystkich", obecni: [], wyniki: {}, lista_glosow: {} });
            q.forEach(async (d) => await deleteDoc(doc(db, "archiwum_sesji", d.id)));
        };

        window.dodajK = async () => {
            const k = document.getElementById('nK').value.trim();
            const n = document.getElementById('nN').value.trim();
            if(k && n) {
                await setDoc(doc(db, "kody_dostepu", k), { nazwisko: n });
                document.getElementById('nK').value = ""; document.getElementById('nN').value = "";
            }
        };

        window.usunK = async (id) => { await deleteDoc(doc(db, "kody_dostepu", id)); };
        window.usunO = async (n) => { 
            const s = await getDoc(docRef); 
            await updateDoc(docRef, { obecni: s.data().obecni.filter(o => o !== n) }); 
        };
    </script>
</body>
</html>
