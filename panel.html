<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Administratora Sesji</title>
    <style>
        body { font-family: sans-serif; background: #fdfdfd; display: flex; gap: 15px; padding: 15px; font-size: 14px; }
        .box { flex: 1; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        h3 { border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 0; }
        input, button { width: 100%; padding: 10px; margin: 4px 0; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; background: #3498db; color: white; border: none; }
        .btn-red { background: #e74c3c; }
        .btn-green { background: #27ae60; }
        .small-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
        .small-list li { display: flex; justify-content: space-between; align-items: center; padding: 6px; border-bottom: 1px solid #f9f9f9; font-size: 12px; }
        .del-btn { width: auto; padding: 2px 6px; background: #c0392b; font-size: 10px; }
    </style>
</head>
<body>

    <div class="box">
        <h3>Głosowanie</h3>
        <input type="text" id="tytul" placeholder="Temat uchwały">
        <button class="btn-green" onclick="uruchom()">START GŁOSOWANIA</button>
        <button onclick="zamknijGlosowanie()">ZAKOŃCZ GŁOSOWANIE</button>
        <button style="background:#2c3e50" id="lockBtn" onclick="toggleLock()">ZABLOKUJ LISTĘ</button>
        <button class="btn-red" style="margin-top:20px" onclick="zakonczSesje()">ZAKOŃCZ SESJĘ & RAPORT</button>
    </div>

    <div class="box">
        <h3>Obecni Radni (<span id="countObecni">0</span>)</h3>
        <ul id="listaObecnych" class="small-list"></ul>
    </div>

    <div class="box">
        <h3>Zarządzanie Kodami</h3>
        <input type="text" id="newImie" placeholder="Imię">
        <input type="text" id="newNazwisko" placeholder="Nazwisko">
        <input type="text" id="newOpis" placeholder="Klasa/Funkcja">
        <input type="text" id="newKod" placeholder="KOD (np. jan123)">
        <button class="btn-green" onclick="dodajKod()">DODAJ NOWY KOD</button>
        <ul id="bazaKodow" class="small-list"></ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBo7bSndks_GClZBvnDMIsdVRWw5oCWiRM",
            authDomain: "votelive-f469d.firebaseapp.com",
            projectId: "votelive-f469d",
            storageBucket: "votelive-f469d.firebasestorage.app",
            messagingSenderId: "959356764271",
            appId: "1:959356764271:web:76f0284a0a1ce6e9874d9a" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "ankiet", "vote");

        onSnapshot(docRef, (snap) => {
            const data = snap.data();
            if(!data) return;
            document.getElementById('countObecni').innerText = data.obecni?.length || 0;
            document.getElementById('lockBtn').innerText = data.lista_lock ? "OTWÓRZ LISTĘ" : "ZABLOKUJ LISTĘ";
            const ul = document.getElementById('listaObecnych');
            ul.innerHTML = "";
            (data.obecni || []).forEach(o => {
                ul.innerHTML += `<li>${o} <button class="del-btn" onclick="usunObecnego('${o}')">WYRZUĆ</button></li>`;
            });
        });

        onSnapshot(collection(db, "kody_dostepu"), (snap) => {
            const ul = document.getElementById('bazaKodow');
            ul.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                ul.innerHTML += `<li><b>${d.id}</b>: ${data.imie} ${data.nazwisko} <button class="del-btn" onclick="usunKod('${d.id}')">USUŃ</button></li>`;
            });
        });

        window.dodajKod = async () => {
            const kod = document.getElementById('newKod').value.trim();
            const imie = document.getElementById('newImie').value.trim();
            const nazwisko = document.getElementById('newNazwisko').value.trim();
            const opis = document.getElementById('newOpis').value.trim();
            
            if(!kod || !imie || !nazwisko) return alert("Wypełnij pola!");
            
            await setDoc(doc(db, "kody_dostepu", kod), { imie, nazwisko, opis });
            
            // Czyszczenie pól po dodaniu
            document.getElementById('newKod').value = "";
            document.getElementById('newImie').value = "";
            document.getElementById('newNazwisko').value = "";
            document.getElementById('newOpis').value = "";
        };

        window.usunKod = async (id) => { if(confirm("Usunąć kod dostępu? Radny zostanie wylogowany.")) await deleteDoc(doc(db, "kody_dostepu", id)); };

        window.usunObecnego = async (nazwa) => {
            const snap = await getDoc(docRef);
            const obecni = (snap.data().obecni || []).filter(o => o !== nazwa);
            await updateDoc(docRef, { obecni: obecni });
        };

        window.toggleLock = async () => {
            const snap = await getDoc(docRef);
            await updateDoc(docRef, { lista_lock: !snap.data().lista_lock });
        };

        window.uruchom = async () => {
            const t = document.getElementById('tytul').value || "Głosowanie";
            await updateDoc(docRef, { tytul: t, wyniki: { "ZA": 0, "PRZECIW": 0, "WSTRZYMAŁO SIĘ": 0 }, lista_glosow: {}, status: "otwarte", tryb: "reset" });
        };

        window.zamknijGlosowanie = async () => {
            const snap = await getDoc(docRef);
            await updateDoc(docRef, { status: "zamkniete" });
            await setDoc(doc(collection(db, "archiwum_sesji")), { ...snap.data(), data_godz: new Date().toLocaleString() });
        };

        window.zakonczSesje = async () => {
            if(!confirm("Koniec sesji?")) return;
            const query = await getDocs(collection(db, "archiwum_sesji"));
            let r = "RAPORT SESJI\n";
            query.forEach(d => r += `\nUCHWAŁA: ${d.data().tytul}\nZA: ${d.data().wyniki.ZA}, PRZECIW: ${d.data().wyniki.PRZECIW}\n`);
            const blob = new Blob([r], {type:'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "Sesja.txt"; a.click();
            await setDoc(docRef, { obecni: [], lista_lock: false, status: "reset_wszystkich", wyniki: {}, tytul: "Oczekiwanie..." });
            query.forEach(async (d) => await deleteDoc(doc(db, "archiwum_sesji", d.id)));
        };
    </script>
</body>
</html>
